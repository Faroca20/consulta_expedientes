<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Expedientes - DIF</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        body { 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1300px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header p {
            font-size: 18px;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 25px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-number {
            font-size: 42px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 16px;
            color: #666;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px;
            background: white;
            border-bottom: 1px solid #e9ecef;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .search-box {
            position: relative;
            flex-grow: 1;
            max-width: 400px;
        }
        
        .search-box input {
            width: 100%;
            padding: 14px 20px 14px 50px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            border-color: #0078d4;
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
            outline: none;
        }
        
        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #106ebe 0%, #005a9e 100%);
            box-shadow: 0 6px 15px rgba(0, 120, 212, 0.2);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #388E3C 0%, #2E7D32 100%);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.2);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #FFC107 0%, #FFA000 100%);
            color: white;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #FFA000 0%, #FF8F00 100%);
            box-shadow: 0 6px 15px rgba(255, 193, 7, 0.2);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            box-shadow: 0 6px 15px rgba(220, 53, 69, 0.2);
        }
        
        .table-container {
            padding: 0;
            overflow-x: auto;
        }
        
        .expedientes-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        .expedientes-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px 15px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 3px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .expedientes-table td {
            padding: 20px 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }
        
        .expedientes-table tr:hover td {
            background: #f8fafc;
        }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-badge::before {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .badge-verde {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.05) 100%);
            color: #2E7D32;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }
        
        .badge-verde::before {
            background: #4CAF50;
        }
        
        .badge-amarillo {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%);
            color: #F57C00;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        .badge-amarillo::before {
            background: #FFC107;
        }
        
        .badge-naranja {
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.1) 0%, rgba(255, 152, 0, 0.05) 100%);
            color: #EF6C00;
            border: 1px solid rgba(255, 152, 0, 0.2);
        }
        
        .badge-naranja::before {
            background: #FF9800;
        }
        
        .badge-rojo {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.1) 0%, rgba(244, 67, 54, 0.05) 100%);
            color: #C62828;
            border: 1px solid rgba(244, 67, 54, 0.2);
        }
        
        .badge-rojo::before {
            background: #F44336;
        }
        
        .legend {
            padding: 25px;
            background: linear-gradient(135deg, #f8fafc 0%, #e3f2fd 100%);
            border-top: 2px solid #e9ecef;
        }
        
        .legend h3 {
            color: #0078d4;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(0,0,0,0.1);
        }
        
        .color-verde { background: #4CAF50; }
        .color-amarillo { background: #FFC107; }
        .color-naranja { background: #FF9800; }
        .color-rojo { background: #F44336; }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }
        
        .modal {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.4s;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            color: white;
            padding: 25px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 0;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .close-modal:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .modal-content {
            padding: 30px;
        }
        
        .modal-footer {
            padding: 20px 30px;
            background: #f8f9fa;
            border-radius: 0 0 15px 15px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        .modal-notificaciones {
            max-width: 900px;
        }
        
        .tabs-notificaciones {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab-btn:hover {
            color: #0078d4;
        }
        
        .tab-btn.active {
            color: #0078d4;
            border-bottom-color: #0078d4;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .login-container {
            text-align: center;
            padding: 40px 20px;
        }
        
        .login-icon {
            font-size: 64px;
            margin-bottom: 20px;
            color: #0078d4;
        }
        
        .password-input {
            position: relative;
            margin: 20px 0;
        }
        
        .password-input input {
            width: 100%;
            padding: 14px 50px 14px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            letter-spacing: 3px;
            transition: all 0.3s;
        }
        
        .password-input input:focus {
            border-color: #0078d4;
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
            outline: none;
        }
        
        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 18px;
        }
        
        .notificaciones-panel {
            padding: 20px;
        }
        
        .user-list {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }
        
        .user-item:hover {
            background: #f8f9fa;
        }
        
        .user-item:last-child {
            border-bottom: none;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .user-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }
        
        .user-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 6px;
        }
        
        .btn-icon {
            padding: 8px;
            border-radius: 6px;
            background: none;
            border: 1px solid #ddd;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .btn-icon:hover {
            background: #f0f0f0;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #0078d4;
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
            outline: none;
        }
        
        .file-upload {
            border: 2px dashed #0078d4;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            background: rgba(0, 120, 212, 0.05);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload:hover {
            background: rgba(0, 120, 212, 0.1);
        }
        
        .file-upload input {
            display: none;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .config-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 120, 212, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 100;
            transition: all 0.3s;
        }
        
        .config-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 120, 212, 0.4);
        }
        
        .usuarios-notificacion-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .usuario-notificacion-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        .usuario-notificacion-item:hover {
            background: #f0f7ff;
            border-color: #0078d4;
        }
        
        .usuario-notificacion-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .usuario-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .usuario-detalles h4 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }
        
        .usuario-detalles p {
            margin: 2px 0 0 0;
            font-size: 14px;
            color: #666;
        }
        
        .historial-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #0078d4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .historial-subidas {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .historial-subida-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .user-name-display {
            font-size: 24px;
            font-weight: bold;
            color: #0078d4;
            margin: 20px 0;
            padding: 10px;
            background: #f0f7ff;
            border-radius: 8px;
            text-align: center;
        }
        
        .backup-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 24px; }
            .controls { flex-direction: column; align-items: stretch; }
            .search-box { max-width: 100%; }
            .stats-container { grid-template-columns: 1fr 1fr; }
            .user-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .user-actions { align-self: flex-end; }
        }
        
        @media (max-width: 480px) {
            .stats-container { grid-template-columns: 1fr; }
            .header { padding: 20px; }
            .controls { padding: 15px; }
            .modal { width: 95%; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #0078d4;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #106ebe;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <script>
    const EMAILJS_PUBLIC_KEY = "KlfdPY2IzmTp8MRzH";
    
    (function() {
        try {
            if (typeof emailjs !== 'undefined') {
                emailjs.init(EMAILJS_PUBLIC_KEY);
            }
        } catch (error) {
            console.log("Error:", error);
        }
    })();
    </script>
</head>
<body>
    <!-- Bot√≥n para administrador -->
    <button class="config-button" onclick="mostrarLoginAdmin()" title="Acceso Administrador">
        üîí
    </button>

    <div id="adminLoginModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h2>üîê Acceso Administrador</h2>
            <button class="close-modal" onclick="cerrarLoginAdmin()">&times;</button>
        </div>
        <div class="modal-content">
            <div class="login-container">
                <div class="login-icon">üëë</div>
                <h3>Panel de Administraci√≥n</h3>
                <p style="color: #666; margin-bottom: 20px;">
                    Ingrese la contrase√±a de administrador para continuar.
                    <br><small>Contrase√±a: Extensiva2026</small>
                </p>
                <div class="password-input">
                    <input type="password" id="adminPassword" 
                           placeholder="Contrase√±a de administrador" autocomplete="off"
                           onkeypress="if(event.key === 'Enter') validarAccesoAdminCompleto()">
                    <button class="toggle-password" type="button" 
                            onclick="togglePasswordVisibility('adminPassword')">
                        üëÅÔ∏è
                    </button>
                </div>
                <div id="adminPasswordError" style="color: #dc3545; margin: 10px 0; display: none;">
                    ‚ùå Contrase√±a incorrecta. Intente con: Extensiva2026
                </div>
                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="validarAccesoAdminCompleto()">
                        üîë Ingresar como Administrador
                    </button>
                    <button class="btn" onclick="cerrarLoginAdmin()" style="margin-left: 10px;">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- MODAL CONFIGURACI√ìN -->
    <div id="configModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2>‚öôÔ∏è Panel de Administraci√≥n</h2>
                <button class="close-modal" onclick="cerrarModalConfiguracion()">&times;</button>
            </div>
            <div class="modal-content">
                <div class="tabs-notificaciones">
                    <button class="tab-btn active" onclick="cambiarTabAdmin('expedientes')">üìÅ Expedientes</button>
                    <button class="tab-btn" onclick="cambiarTabAdmin('usuarios')">üë• Usuarios</button>
                    <button class="tab-btn" onclick="cambiarTabAdmin('notificaciones')">üîî Notificaciones</button>
                    <button class="tab-btn" onclick="cambiarTabAdmin('historial')">üìã Historial</button>
                    <button class="tab-btn" onclick="cambiarTabAdmin('backup')">üíæ Copia Seguridad</button>
                    <button class="tab-btn" onclick="cambiarTabAdmin('github')">‚òÅÔ∏è GitHub</button>
                </div>
                
                <!-- PESTA√ëA EXPEDIENTES -->
                <div id="tab-expedientes" class="tab-content active">
                    <div class="form-group">
                        <label>üìÅ Cargar Archivo de Expedientes</label>
                        <p style="margin-bottom: 15px; color: #666;">Suba un archivo Excel (.xlsx, .xls) o CSV:</p>
                        <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" onchange="handleFileUpload(event)" style="display: none;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üì§</div>
                            <h3 style="color: #0078d4; margin-bottom: 10px;">Haga clic para cargar archivo</h3>
                            <p style="color: #666;">Formatos: Excel (.xlsx, .xls) o CSV</p>
                        </div>
                        <div id="fileInfo" class="file-info" style="display: none;">
                            <div>
                                <strong id="fileName"></strong><br>
                                <span id="fileSize"></span><br>
                                <span id="fileType"></span>
                            </div>
                            <div>
                                <button class="btn btn-small btn-success" onclick="procesarArchivo()" id="procesarBtn">
                                    üìã Cargar al Sistema
                                </button>
                                <button class="btn btn-small btn-danger" onclick="eliminarArchivo()">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        <div id="processingInfo" style="display: none; margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 5px;">
                            <span id="processingText"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>üìÖ Configuraci√≥n de Fechas</label>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <strong>Fecha de referencia actual:</strong>
                            <span id="fechaReferenciaActual" style="background: #f0f0f0; padding: 5px 10px; border-radius: 4px;"></span>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-warning" onclick="cambiarFechaReferencia()">
                                üìÖ Cambiar Fecha
                            </button>
                            <button class="btn btn-success" onclick="usarFechaActual()">
                                üïê Usar Fecha Actual
                            </button>
                            <button class="btn" onclick="recalcularTodosExpedientes()">
                                üîÑ Recalcular
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>‚ö° Acciones</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="exportarExcel()">
                                üì• Exportar a Excel
                            </button>
                            <button class="btn btn-danger" onclick="limpiarDatos()">
                                üóëÔ∏è Limpiar Datos
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- PESTA√ëA GITHUB -->
                <div id="tab-github" class="tab-content">
                    <div class="form-group">
                        <label>‚òÅÔ∏è Configuraci√≥n de GitHub</label>
                        
                        <div id="githubStatus" style="margin: 20px 0; padding: 15px; border-radius: 10px; background: #f8f9fa;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <div id="githubIcon" style="font-size: 24px;">üîó</div>
                                <div>
                                    <h4 style="margin: 0;">Estado de GitHub</h4>
                                    <p id="githubStatusText" style="margin: 5px 0 0 0; color: #666;">
                                        Verificando conexi√≥n...
                                    </p>
                                </div>
                            </div>
                            <button class="btn btn-small" onclick="verificarConexionGitHub()" style="margin-top: 10px;">
                                üîÑ Verificar conexi√≥n
                            </button>
                        </div>
                        
                        <div style="margin: 25px 0;">
                            <h4>üîë Configurar Token de Acceso</h4>
                            <p style="color: #666; margin-bottom: 15px;">
                                Configure su token de GitHub para publicar datos autom√°ticamente.
                            </p>
                            
                            <div class="token-help" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <strong>üìã C√≥mo obtener el token:</strong>
                                <ol style="margin: 10px 0 0 20px;">
                                    <li>Vaya a: <a href="https://github.com/settings/tokens" target="_blank">github.com/settings/tokens</a></li>
                                    <li>Haga clic en "Generate new token" ‚Üí "Generate new token (classic)"</li>
                                    <li>En "Note" escriba: Sistema Expedientes DIF</li>
                                    <li>En "Expiration" seleccione: No expiration</li>
                                    <li>En "Select scopes" marque SOLO: <code>public_repo</code></li>
                                    <li>Haga clic en "Generate token"</li>
                                    <li><strong>¬°COPIE EL TOKEN INMEDIATAMENTE!</strong></li>
                                </ol>
                            </div>
                            
                            <div style="margin: 20px 0;">
                                <label>Token de GitHub:</label>
                                <input type="password" id="githubTokenInput" class="token-input" 
                                       placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <div style="display: flex; align-items: center; margin-top: 5px;">
                                    <input type="checkbox" id="showToken" onchange="toggleShowToken()">
                                    <label for="showToken" style="margin-left: 5px; font-size: 14px;">Mostrar token</label>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-success" onclick="guardarTokenGitHub()">
                                    üíæ Guardar Token
                                </button>
                                <button class="btn btn-primary" onclick="probarTokenGitHub()">
                                    üîç Probar Token
                                </button>
                                <button class="btn btn-danger" onclick="eliminarTokenGitHub()">
                                    üóëÔ∏è Eliminar Token
                                </button>
                            </div>
                        </div>
                        
                        <div style="margin: 30px 0; padding: 20px; background: #e7f3ff; border-radius: 10px;">
                            <h4>üöÄ Publicar Datos</h4>
                            <p style="color: #666; margin-bottom: 15px;">
                                Publica los datos actuales para que todos los usuarios los vean.
                            </p>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                                    <div style="font-size: 24px; font-weight: bold; color: #0078d4;" id="expedientesCount">0</div>
                                    <div>Expedientes a publicar</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                                    <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="ultimaPublicacion">Nunca</div>
                                    <div>√öltima publicaci√≥n</div>
                                </div>
                            </div>
                            
                            <button class="btn btn-github" onclick="publicarDatosGitHub()" style="width: 100%; padding: 15px; font-size: 16px;">
                                ‚òÅÔ∏è Publicar en GitHub
                            </button>
                            
                            <div style="margin-top: 20px; display: flex; gap: 10px;">
                                <button class="btn" onclick="exportarParaUsuarios()">
                                    üì• Exportar para usuarios
                                </button>
                                <button class="btn" onclick="verDatosPublicados()">
                                    üëÅÔ∏è Ver datos publicados
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="guardarConfiguracion()">
                    üíæ Guardar
                </button>
                <button class="btn" onclick="cerrarModalConfiguracion()">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- A√±ade esto dentro del modal de configuraci√≥n, despu√©s de la pesta√±a de GitHub -->
<div id="tab-usuarios" class="tab-content">
    <div class="form-group">
        <label>üë• Gesti√≥n de Usuarios</label>
        <p style="margin-bottom: 15px; color: #666;">Usuarios detectados autom√°ticamente:</p>
        <div class="user-list" id="userList" style="margin-top: 15px; max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; background: #f8f9fa;">
            <!-- Los usuarios se cargar√°n aqu√≠ -->
        </div>
        <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="agregarUsuario()">
                ‚ûï Agregar Usuario
            </button>
            <button class="btn btn-danger" onclick="eliminarTodosUsuarios()">
                üóëÔ∏è Eliminar Todos
            </button>
        </div>
    </div>
</div>

<div id="tab-notificaciones" class="tab-content">
    <div class="form-group">
        <label>üîî Sistema de Notificaciones</label>
        <div style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="mostrarModalNotificaciones()" style="width: 100%; padding: 20px; font-size: 18px;">
                üìß Abrir M√≥dulo de Notificaciones
            </button>
        </div>
        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
            <h4>üìä Estad√≠sticas</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #0078d4;" id="totalUsuariosNotificacion">0</div>
                    <div style="color: #666;">Usuarios</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="totalNotificacionesEnviadas">0</div>
                    <div style="color: #666;">Notificaciones</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #ffc107;" id="expedientesVencidos">0</div>
                    <div style="color: #666;">Vencidos</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #6c757d;" id="ultimaNotificacion">Nunca</div>
                    <div style="color: #666;">√öltima</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="tab-historial" class="tab-content">
    <div class="form-group">
        <label>üìã Historial de Subidas</label>
        <div class="historial-subidas" id="historialSubidas" style="margin-top: 20px; max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; background: #f8f9fa;">
            <!-- El historial se cargar√° aqu√≠ -->
        </div>
        <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button class="btn btn-success" onclick="exportarHistorialExcel()">
                üì• Exportar Historial a Excel
            </button>
            <button class="btn btn-danger" onclick="limpiarHistorialSubidas()">
                üóëÔ∏è Limpiar Historial
            </button>
        </div>
    </div>
</div>

<div id="tab-backup" class="tab-content">
    <div class="backup-section" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 1px solid #dee2e6;">
        <h3>üíæ Sistema de Copia de Seguridad</h3>
        <p style="color: #666; margin-bottom: 20px;">
            Realice copias de seguridad de todos los datos del sistema para transferirlos a otro equipo.
        </p>
        
        <div style="margin: 30px 0;">
            <h4>üì§ Descargar Copia de Seguridad</h4>
            <p style="color: #666; margin-bottom: 15px;">
                Descargue un archivo JSON con todos los datos del sistema:
            </p>
            <button class="btn btn-success" onclick="descargarBackup()">
                üíæ Descargar Backup
            </button>
        </div>
        
        <div style="margin: 30px 0; padding: 20px; background: #e7f3ff; border-radius: 10px;">
            <h4>üì• Restaurar Copia de Seguridad</h4>
            <p style="color: #666; margin-bottom: 15px;">
                Suba un archivo JSON de backup para restaurar todos los datos:
            </p>
            <div class="file-upload" onclick="document.getElementById('backupFileInput').click()" style="border: 2px dashed #0078d4; border-radius: 10px; padding: 40px 20px; text-align: center; background: rgba(0, 120, 212, 0.05); cursor: pointer; transition: all 0.3s;">
                <input type="file" id="backupFileInput" accept=".json" onchange="handleBackupUpload(event)" style="display: none;">
                <div style="font-size: 48px; margin-bottom: 15px;">üìÇ</div>
                <h3 style="color: #0078d4; margin-bottom: 10px;">Haga clic para cargar backup</h3>
                <p style="color: #666;">Formato: JSON (.json)</p>
            </div>
            <div id="backupFileInfo" class="file-info" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <strong id="backupFileName"></strong><br>
                    <span id="backupFileSize"></span>
                </div>
                <div>
                    <button class="btn btn-small btn-success" onclick="restaurarBackup()" id="restaurarBtn" style="padding: 6px 12px; font-size: 14px; border-radius: 6px; background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); color: white; border: none; cursor: pointer;">
                        üîÑ Restaurar
                    </button>
                    <button class="btn btn-small btn-danger" onclick="eliminarBackupFile()" style="padding: 6px 12px; font-size: 14px; border-radius: 6px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; cursor: pointer; margin-left: 5px;">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
            <h4>üìä Informaci√≥n del Backup</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #0078d4;" id="totalExpedientesBackup">0</div>
                    <div style="color: #666;">Expedientes</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="totalUsuariosBackup">0</div>
                    <div style="color: #666;">Usuarios</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #ffc107;" id="historialSubidasCount">0</div>
                    <div style="color: #666;">Subidas</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #6c757d;" id="ultimaSubida">Nunca</div>
                    <div style="color: #666;">√öltima</div>
                </div>
            </div>
        </div>
    </div>
</div>



    <!-- CONTENIDO PRINCIPAL -->
    <div class="container" id="mainContent">
        <div class="header">
            <h1>üèõÔ∏è Sistema de Seguimiento de Expedientes</h1>
            <p>Divisi√≥n de Fiscalizaci√≥n y Liquidaci√≥n Tributaria Extensiva</p>
            <!-- Mostrar nombre del funcionario cuando sea usuario -->
            <div id="userNameDisplay" class="user-name-display" style="display: none; font-size: 24px; font-weight: bold; color: #0078d4; margin: 20px 0; padding: 10px; background: #f0f7ff; border-radius: 8px; text-align: center;"></div>
        </div>
        
        <div class="stats-container">
            <div class="stat-card"><div class="stat-number" id="total-count">0</div><div class="stat-label">Total</div></div>
            <div class="stat-card"><div class="stat-number verde" id="verde-count">0</div><div class="stat-label verde">En Tiempo</div></div>
            <div class="stat-card"><div class="stat-number amarillo" id="amarillo-count">0</div><div class="stat-label amarillo">Alerta</div></div>
            <div class="stat-card"><div class="stat-number rojo" id="rojo-count">0</div><div class="stat-label rojo">Vencidos</div></div>
        </div>
        
        <div class="controls">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="search-input" placeholder="Buscar por expediente, responsable o descripci√≥n...">
            </div>
            
            <!-- NUEVO: Bot√≥n para actualizar desde GitHub -->
            <button id="btnActualizarGitHub" class="btn btn-primary" style="margin-left: 10px; display: none;">
                üîÑ Actualizar desde la Nube
            </button>
            
            <!-- NUEVO: Bot√≥n para publicar (solo admin) -->
            <button id="btnPublicarGitHub" class="btn btn-github" style="margin-left: 10px; display: none;">
                ‚òÅÔ∏è Publicar para Todos
            </button>
            
            <!-- NUEVO: Indicador de estado -->
            <div id="syncIndicator" class="sync-status" style="margin-left: 15px; padding: 6px 12px; border-radius: 15px; font-size: 11px; font-weight: bold; background: #f8f9fa; color: #6c757d; display: inline-flex; align-items: center; gap: 5px;">
                <span>üíª Modo local</span>
            </div>
        </div>
        
        <div class="table-container">
            <table class="expedientes-table">
                <thead>
                    <tr>
                        <th width="12%">Expediente</th>
                        <th width="25%">Descripci√≥n</th>
                        <th width="10%">Estado</th>
                        <th width="12%">Tiempo Restante</th>
                        <th width="12%">Responsable</th>
                        <th width="12%">Fecha Base</th>
                        <th width="5%">Acciones</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
        
        <div class="legend">
            <h3>üìã Leyenda de Estados</h3>
            <div class="legend-items" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <div class="legend-item" style="display: flex; align-items: center; gap: 15px; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <div class="legend-color color-verde" style="width: 24px; height: 24px; border-radius: 50%; background: #4CAF50; border: 2px solid rgba(0,0,0,0.1);"></div>
                    <div><strong>VERDE</strong><br>En tiempo (4+ y 3 meses)</div>
                </div>
                <div class="legend-item" style="display: flex; align-items: center; gap: 15px; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <div class="legend-color color-amarillo" style="width: 24px; height: 24px; border-radius: 50%; background: #FFC107; border: 2px solid rgba(0,0,0,0.1);"></div>
                    <div><strong>AMARILLO</strong><br>Alerta (2 meses)</div>
                </div>
                <div class="legend-item" style="display: flex; align-items: center; gap: 15px; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <div class="legend-color color-naranja" style="width: 24px; height: 24px; border-radius: 50%; background: #FF9800; border: 2px solid rgba(0,0,0,0.1);"></div>
                    <div><strong>NARANJA</strong><br>Pr√≥ximo (1 mes)</div>
                </div>
                <div class="legend-item" style="display: flex; align-items: center; gap: 15px; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <div class="legend-color color-rojo" style="width: 24px; height: 24px; border-radius: 50%; background: #F44336; border: 2px solid rgba(0,0,0,0.1);"></div>
                    <div><strong>ROJO</strong><br>Vencido (0 o menos meses)</div>
                </div>
            </div>
        </div>
    </div>

<!-- ============================================== -->
<!-- JAVASCRIPT COMPLETO -->
<!-- ============================================== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>

// ==============================================
// VARIABLES GLOBALES
// ==============================================
let expedientes = [];
let filteredExpedientes = [];
let archivoCargado = null;
let archivoBackup = null;
let usuariosDisponibles = [];
let usuariosNotificacion = [];
let historialSubidas = [];
let funcionarioActual = null;

let adminConfig = {
    password: 'Extensiva2026',
    sesionActiva: false,
    tiempoSesion: 60
};

let fechaReferencia = new Date('2025-12-18');
const PERIODO_REVISION_MESES = 4;


// ==============================================
// SISTEMA UNIFICADO DE ACCESO ADMINISTRADOR
// ==============================================

function mostrarLoginAdmin() {
    // Si ya es administrador, mostrar directamente
    if (funcionarioActual === 'Administrador') {
        mostrarModalConfiguracion();
        return;
    }
    
    // Mostrar modal de login
    document.getElementById('adminLoginModal').style.display = 'flex';
    document.getElementById('adminPassword').focus();
}

function cerrarLoginAdmin() {
    document.getElementById('adminLoginModal').style.display = 'none';
    document.getElementById('adminPassword').value = '';
    document.getElementById('adminPasswordError').style.display = 'none';
}

function validarAccesoAdminCompleto() {
    const passwordInput = document.getElementById('adminPassword');
    const errorDiv = document.getElementById('adminPasswordError');
    const password = passwordInput ? passwordInput.value.trim() : '';
    
    // Contrase√±a correcta
    if (password === 'Extensiva2026') {
        // Establecer como administrador
        funcionarioActual = 'Administrador';
        
        // Guardar en localStorage
        localStorage.setItem('dif_documento_usuario', 'Administrador');
        localStorage.setItem('dif_documento_identificacion', 'admin');
        
        // Configurar botones GitHub
        configurarBotonesGitHub();
        
        // Mostrar nombre
        document.getElementById('userNameDisplay').style.display = 'block';
        document.getElementById('userNameDisplay').textContent = 'üëë Administrador';
        
        // Mostrar todos los expedientes
        filteredExpedientes = [...expedientes];
        actualizarTabla();
        actualizarEstadisticas();
        
        // Cerrar modal login
        cerrarLoginAdmin();
        
        // Mostrar panel de administraci√≥n
        mostrarModalConfiguracion();
        
        mostrarNotificacion('‚úÖ Acceso de administrador concedido', 'success');
        
    } else {
        // Contrase√±a incorrecta
        if (errorDiv) {
            errorDiv.style.display = 'block';
        }
        if (passwordInput) {
            passwordInput.style.borderColor = '#dc3545';
            passwordInput.value = '';
            passwordInput.focus();
        }
        
        // Vibraci√≥n para feedback
        if (navigator.vibrate) {
            navigator.vibrate(200);
        }
    }
}

// Funci√≥n auxiliar para mostrar modal de configuraci√≥n
function mostrarModalConfiguracion() {
    // Verificar que sea administrador
    if (funcionarioActual !== 'Administrador') {
        mostrarLoginAdmin();
        return;
    }
    
    document.getElementById('configModal').style.display = 'flex';
    
    // Inicializar todas las pesta√±as
    cargarListaUsuarios();
    cargarHistorialSubidas();
    actualizarInfoBackup();
    actualizarEstadisticasNotificaciones();
    actualizarInfoGitHub();
    
    // Mostrar fecha de referencia
    if (document.getElementById('fechaReferenciaActual')) {
        document.getElementById('fechaReferenciaActual').textContent = 
            fechaReferencia.toLocaleDateString();
    }
    
    cambiarTabAdmin('expedientes');
}

function cerrarModalConfiguracion() {
    document.getElementById('configModal').style.display = 'none';
}

// Funci√≥n para cambiar de usuario (salir de admin)
function cambiarUsuario() {
    if (confirm('¬øCerrar sesi√≥n de administrador?')) {
        funcionarioActual = null;
        localStorage.removeItem('dif_documento_usuario');
        localStorage.removeItem('dif_documento_identificacion');
        
        document.getElementById('userNameDisplay').style.display = 'none';
        
        // Mostrar modal para ingresar como usuario normal
        setTimeout(() => {
            pedirDocumentoUsuario();
        }, 500);
        
        mostrarNotificacion('Sesi√≥n de administrador cerrada', 'info');
    }
}

// Agregar bot√≥n para cambiar usuario en el header
function agregarBotonCambiarUsuario() {
    if (funcionarioActual === 'Administrador') {
        const header = document.querySelector('.header');
        if (header && !document.getElementById('btnCambiarUsuario')) {
            const btnCambiar = document.createElement('button');
            btnCambiar.id = 'btnCambiarUsuario';
            btnCambiar.className = 'btn btn-warning';
            btnCambiar.style.marginTop = '10px';
            btnCambiar.innerHTML = 'üë§ Cambiar de Usuario';
            btnCambiar.onclick = cambiarUsuario;
            
            const userDisplay = document.getElementById('userNameDisplay');
            if (userDisplay) {
                userDisplay.parentNode.insertBefore(btnCambiar, userDisplay.nextSibling);
            }
        }
    }
}

// Modificar la funci√≥n de inicializaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    // ... c√≥digo existente ...
    
    // Despu√©s de verificar usuario, agregar bot√≥n si es admin
    if (funcionarioActual === 'Administrador') {
        agregarBotonCambiarUsuario();
    }
    
    // Configurar evento para tecla Escape en modales
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            cerrarLoginAdmin();
            cerrarModalConfiguracion();
        }
    });
});







// ==============================================
// CONFIGURACI√ìN GITHUB - SEGURA
// ==============================================
let githubToken = null;
const GITHUB_CONFIG = {
    usuario: 'faroca20',
    repositorio: 'consulta_expedientes',
    archivo: 'datos/expedientes.json',
    branch: 'main'
};

// URL p√∫blica para leer datos (no necesita token)
const GITHUB_DATA_URL = `https://raw.githubusercontent.com/${GITHUB_CONFIG.usuario}/${GITHUB_CONFIG.repositorio}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.archivo}`;

// ==============================================
// FUNCIONES AUXILIARES
// ==============================================
function extraerNombreSinDocumento(responsableCompleto) {
    if (!responsableCompleto || responsableCompleto.trim() === '') {
        return 'No asignado';
    }
    
    responsableCompleto = responsableCompleto.trim();
    
    if (responsableCompleto.includes('-')) {
        const partes = responsableCompleto.split('-');
        return partes[0].trim();
    }
    
    if (responsableCompleto.includes('(') && responsableCompleto.includes(')')) {
        const indiceParentesis = responsableCompleto.indexOf('(');
        return responsableCompleto.substring(0, indiceParentesis).trim();
    }
    
    const partes = responsableCompleto.split(/\s+/);
    
    for (let i = 0; i < partes.length; i++) {
        if (/^\d{5,12}$/.test(partes[i])) {
            partes.splice(i, 1);
            return partes.join(' ').trim();
        }
    }
    
    return responsableCompleto;
}

function extraerDocumentoDeResponsable(responsableCompleto) {
    if (!responsableCompleto) return '';
    const match = responsableCompleto.match(/\b\d{5,12}\b/);
    return match ? match[0] : '';
}

// ==============================================
// SISTEMA GITHUB COMPLETO
// ==============================================

// 1. INICIALIZAR SISTEMA GITHUB
function inicializarSistemaGitHub() {
    // Cargar token guardado (si existe)
    cargarTokenGuardado();
    
    // Configurar botones seg√∫n tipo de usuario
    configurarBotonesGitHub();
    
    // Actualizar indicador de estado
    actualizarIndicadorEstado();
    
    // Verificar datos en la nube (si hay conexi√≥n)
    if (navigator.onLine) {
        setTimeout(() => {
            verificarActualizacionesGitHub();
        }, 2000);
    }
}

// 2. CARGAR TOKEN GUARDADO
function cargarTokenGuardado() {
    try {
        const tokenGuardado = localStorage.getItem('github_token');
        if (tokenGuardado && tokenGuardado.startsWith('ghp_')) {
            githubToken = tokenGuardado;
            console.log('‚úÖ Token cargado del almacenamiento local');
            return true;
        }
    } catch (e) {
        console.log('No hay token guardado');
    }
    return false;
}

// 3. CONFIGURAR BOTONES
function configurarBotonesGitHub() {
    const btnActualizar = document.getElementById('btnActualizarGitHub');
    const btnPublicar = document.getElementById('btnPublicarGitHub');
    
    if (btnActualizar) {
        btnActualizar.style.display = 'inline-block';
        btnActualizar.onclick = cargarDatosDesdeGitHub;
        btnActualizar.title = 'Actualizar datos desde GitHub';
    }
    
    if (btnPublicar && funcionarioActual === 'Administrador') {
        btnPublicar.style.display = 'inline-block';
        btnPublicar.onclick = publicarDatosGitHub;
        btnPublicar.title = 'Publicar datos para todos los usuarios';
    }
}

// 4. PUBLICAR DATOS A GITHUB
async function publicarDatosGitHub() {
    // Verificar si es administrador
    if (funcionarioActual !== 'Administrador') {
        mostrarNotificacion('‚ùå Solo el administrador puede publicar datos', 'error');
        return;
    }
    
    // Verificar si hay datos para publicar
    if (expedientes.length === 0) {
        mostrarNotificacion('‚ùå No hay datos para publicar', 'error');
        return;
    }
    
    // Verificar token
    if (!githubToken) {
        mostrarModalConfigurarToken();
        return;
    }
    
    // Mostrar confirmaci√≥n
    if (!confirm(`¬øPublicar ${expedientes.length} expedientes para todos los usuarios?\n\nEsta acci√≥n actualizar√° los datos en la nube.`)) {
        return;
    }
    
    mostrarNotificacion('üîÑ Publicando datos en GitHub...', 'info');
    
    try {
        // Preparar datos
        const datosParaPublicar = {
            expedientes: expedientes,
            usuarios: usuariosDisponibles,
            fechaPublicacion: new Date().toISOString(),
            totalExpedientes: expedientes.length,
            version: '1.0',
            publicadoPor: funcionarioActual
        };
        
        // Subir a GitHub
        const resultado = await subirAGitHub(datosParaPublicar);
        
        if (resultado.success) {
            // Actualizar interfaz
            actualizarInfoGitHub();
            actualizarIndicadorEstado('publicado', new Date());
            
            // Mostrar √©xito
            mostrarNotificacion(`‚úÖ ${expedientes.length} expedientes publicados`, 'success');
            
            // Guardar fecha de √∫ltima publicaci√≥n
            localStorage.setItem('ultima_publicacion', new Date().toISOString());
            
            // Mostrar detalles
            setTimeout(() => {
                alert(`üéâ Publicaci√≥n exitosa!\n\n‚Ä¢ Expedientes: ${expedientes.length}\n‚Ä¢ Usuarios: ${usuariosDisponibles.length}\n‚Ä¢ Fecha: ${new Date().toLocaleString()}\n\nLos usuarios pueden actualizar sus datos.`);
            }, 500);
            
        } else {
            mostrarNotificacion('‚ùå Error al publicar: ' + resultado.error, 'error');
        }
        
    } catch (error) {
        console.error('Error:', error);
        mostrarNotificacion('‚ùå Error de conexi√≥n con GitHub', 'error');
    }
}

// 5. SUBIR A GITHUB (funci√≥n t√©cnica)
async function subirAGitHub(datos) {
    const url = `https://api.github.com/repos/${GITHUB_CONFIG.usuario}/${GITHUB_CONFIG.repositorio}/contents/${GITHUB_CONFIG.archivo}`;
    
    try {
        // Obtener SHA del archivo existente
        let sha = null;
        try {
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                sha = data.sha;
            }
        } catch (e) {
            // Archivo no existe
        }
        
        // Convertir a Base64
        const contenido = JSON.stringify(datos, null, 2);
        const contenidoBase64 = btoa(unescape(encodeURIComponent(contenido)));
        
        // Crear cuerpo
        const body = {
            message: `üìä Actualizaci√≥n de expedientes - ${new Date().toLocaleDateString()}`,
            content: contenidoBase64,
            branch: GITHUB_CONFIG.branch
        };
        
        if (sha) {
            body.sha = sha;
        }
        
        // Hacer petici√≥n
        const response = await fetch(url, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${githubToken}`,
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github.v3+json'
            },
            body: JSON.stringify(body)
        });
        
        if (response.ok) {
            const data = await response.json();
            return {
                success: true,
                url: data.content.html_url,
                download_url: data.content.download_url,
                sha: data.content.sha
            };
        } else {
            const errorText = await response.text();
            return {
                success: false,
                error: errorText
            };
        }
        
    } catch (error) {
        return {
            success: false,
            error: error.message
        };
    }
}

// 6. CARGAR DATOS DESDE GITHUB
async function cargarDatosDesdeGitHub() {
    mostrarNotificacion('üîç Buscando datos actualizados...', 'info');
    
    try {
        // Agregar timestamp para evitar cache
        const url = `${GITHUB_DATA_URL}?t=${Date.now()}`;
        const response = await fetch(url);
        
        if (response.ok) {
            const datos = await response.json();
            
            if (datos.expedientes && datos.expedientes.length > 0) {
                // Verificar si son m√°s recientes
                const ultimaCarga = localStorage.getItem('ultima_carga_github');
                const fechaDatos = datos.fechaPublicacion;
                
                if (!ultimaCarga || fechaDatos > ultimaCarga) {
                    // Actualizar datos
                    expedientes = datos.expedientes;
                    usuariosDisponibles = datos.usuarios || [];
                    filteredExpedientes = [...expedientes];
                    
                    // Actualizar interfaz
                    actualizarTabla();
                    actualizarEstadisticas();
                    
                    // Guardar en localStorage
                    localStorage.setItem('dif_configuracion', JSON.stringify({
                        expedientes: expedientes,
                        usuariosDisponibles: usuariosDisponibles,
                        fechaReferencia: fechaReferencia.toISOString(),
                        fuente: 'github',
                        fechaCarga: fechaDatos
                    }));
                    
                    localStorage.setItem('ultima_carga_github', fechaDatos);
                    
                    // Actualizar indicador
                    actualizarIndicadorEstado('actualizado', new Date(fechaDatos));
                    
                    mostrarNotificacion(`‚úÖ ${expedientes.length} expedientes cargados`, 'success');
                    
                    // Si es usuario normal, mostrar mensaje
                    if (funcionarioActual && funcionarioActual !== 'Administrador') {
                        setTimeout(() => {
                            alert(`üì• Datos actualizados\n\nSe cargaron ${expedientes.length} expedientes desde la nube.\nFecha: ${new Date(fechaDatos).toLocaleString()}`);
                        }, 500);
                    }
                    
                } else {
                    mostrarNotificacion('‚úÖ Ya tienes la versi√≥n m√°s reciente', 'info');
                }
            } else {
                mostrarNotificacion('‚ùå No hay datos v√°lidos en la nube', 'warning');
            }
        } else {
            mostrarNotificacion('‚ùå No se pudo conectar con GitHub', 'error');
        }
        
    } catch (error) {
        console.error('Error cargando desde GitHub:', error);
        mostrarNotificacion('‚ùå Error de conexi√≥n', 'error');
    }
}

// 7. VERIFICAR ACTUALIZACIONES AUTOM√ÅTICAMENTE
async function verificarActualizacionesGitHub() {
    try {
        const url = `${GITHUB_DATA_URL}?t=${Date.now()}`;
        const response = await fetch(url, { method: 'HEAD' });
        
        if (response.ok) {
            const lastModified = response.headers.get('last-modified');
            const ultimaVerificacion = localStorage.getItem('ultima_verificacion_github');
            
            if (lastModified && (!ultimaVerificacion || lastModified > ultimaVerificacion)) {
                // Hay actualizaciones disponibles
                mostrarNotificacionActualizacion();
                localStorage.setItem('ultima_verificacion_github', lastModified);
            }
            
            actualizarIndicadorEstado('conectado', null);
        }
    } catch (error) {
        actualizarIndicadorEstado('offline', null);
    }
}

function mostrarNotificacionActualizacion() {
    const notif = document.createElement('div');
    notif.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        z-index: 9998;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        animation: slideInRight 0.3s;
    `;
    
    notif.innerHTML = `
        <span style="font-size: 20px;">üîÑ</span>
        <div>
            <strong>Actualizaci√≥n disponible</strong><br>
            <small>Haga clic para actualizar datos</small>
        </div>
    `;
    
    notif.onclick = () => {
        notif.remove();
        cargarDatosDesdeGitHub();
    };
    
    document.body.appendChild(notif);
    
    // Auto-remover despu√©s de 30 segundos
    setTimeout(() => {
        if (notif.parentNode) {
            notif.parentNode.removeChild(notif);
        }
    }, 30000);
}

// 8. MODAL PARA CONFIGURAR TOKEN
function mostrarModalConfigurarToken() {
    const modalHTML = `
        <div class="modal-overlay" style="display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); align-items: center; justify-content: center; z-index: 1000;">
            <div class="modal" style="background: white; border-radius: 15px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);">
                <div class="modal-header" style="background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%); color: white; padding: 25px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="display: flex; align-items: center; gap: 10px; margin-bottom: 0;">üîë Configurar Token de GitHub</h2>
                    <button class="close-modal" onclick="cerrarModalToken()" style="background: none; border: none; color: white; font-size: 28px; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.3s;">&times;</button>
                </div>
                <div class="modal-content" style="padding: 30px;">
                    <div style="padding: 20px;">
                        <p>Para publicar datos, necesita un token de GitHub.</p>
                        
                        <div style="margin: 20px 0;">
                            <label>Token de GitHub (comienza con ghp_):</label>
                            <input type="password" id="tokenInput" 
                                   style="width: 100%; padding: 12px; border: 2px solid #0078d4; border-radius: 8px; font-family: monospace; margin-top: 5px;"
                                   placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                            <div style="display: flex; align-items: center; margin-top: 5px;">
                                <input type="checkbox" id="showTokenCheck" onchange="toggleTokenVisibility()">
                                <label for="showTokenCheck" style="margin-left: 5px;">Mostrar token</label>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                            <p><strong>¬øC√≥mo obtener el token?</strong></p>
                            <p style="font-size: 12px; margin-top: 5px;">
                                1. Vaya a github.com/settings/tokens<br>
                                2. "Generate new token" ‚Üí "Generate new token (classic)"<br>
                                3. Seleccione solo: <code>public_repo</code><br>
                                4. Copie el token generado
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="guardarTokenDesdeModal()" style="padding: 12px 20px; background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 10px;">
                                üíæ Guardar Token
                            </button>
                            <button class="btn" onclick="cerrarModalToken()" style="padding: 12px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const div = document.createElement('div');
    div.id = 'modalToken';
    div.innerHTML = modalHTML;
    document.body.appendChild(div);
}

function cerrarModalToken() {
    const modal = document.getElementById('modalToken');
    if (modal) modal.remove();
}

function toggleTokenVisibility() {
    const input = document.getElementById('tokenInput');
    const checkbox = document.getElementById('showTokenCheck');
    if (input && checkbox) {
        input.type = checkbox.checked ? 'text' : 'password';
    }
}

function guardarTokenDesdeModal() {
    const input = document.getElementById('tokenInput');
    const token = input ? input.value.trim() : '';
    
    if (!token) {
        alert('‚ùå Ingrese un token');
        return;
    }
    
    if (!token.startsWith('ghp_')) {
        alert('‚ùå Token inv√°lido. Debe comenzar con "ghp_"');
        return;
    }
    
    // Guardar token
    githubToken = token;
    localStorage.setItem('github_token', token);
    
    // Cerrar modal
    cerrarModalToken();
    
    // Mostrar confirmaci√≥n
    mostrarNotificacion('‚úÖ Token guardado localmente', 'success');
    
    // Intentar publicaci√≥n nuevamente
    setTimeout(() => {
        publicarDatosGitHub();
    }, 1000);
}

// 9. ACTUALIZAR INDICADOR DE ESTADO
function actualizarIndicadorEstado(estado = null, fecha = null) {
    const indicador = document.getElementById('syncIndicator');
    if (!indicador) return;
    
    if (estado === 'publicado') {
        indicador.style.background = '#d4edda';
        indicador.style.color = '#155724';
        indicador.style.border = '1px solid #c3e6cb';
        indicador.innerHTML = `<span>‚òÅÔ∏è Publicado: ${fecha ? fecha.toLocaleTimeString().substring(0,5) : 'Ahora'}</span>`;
    } else if (estado === 'actualizado') {
        indicador.style.background = '#d4edda';
        indicador.style.color = '#155724';
        indicador.style.border = '1px solid #c3e6cb';
        indicador.innerHTML = `<span>‚úÖ Actualizado: ${fecha ? fecha.toLocaleTimeString().substring(0,5) : 'Ahora'}</span>`;
    } else if (estado === 'conectado') {
        indicador.style.background = '#d4edda';
        indicador.style.color = '#155724';
        indicador.style.border = '1px solid #c3e6cb';
        indicador.innerHTML = `<span>‚òÅÔ∏è Conectado</span>`;
    } else {
        // Verificar si hay datos de GitHub
        const ultimaCarga = localStorage.getItem('ultima_carga_github');
        if (ultimaCarga) {
            const fecha = new Date(ultimaCarga);
            indicador.style.background = '#d4edda';
            indicador.style.color = '#155724';
            indicador.style.border = '1px solid #c3e6cb';
            indicador.innerHTML = `<span>üìÖ ${fecha.toLocaleDateString()}</span>`;
        } else {
            indicador.style.background = '#f8f9fa';
            indicador.style.color = '#6c757d';
            indicador.style.border = '1px solid #e9ecef';
            indicador.innerHTML = `<span>üíª Modo local</span>`;
        }
    }
}

// 10. FUNCIONES PARA LA PESTA√ëA GITHUB
function toggleShowToken() {
    const input = document.getElementById('githubTokenInput');
    const checkbox = document.getElementById('showToken');
    if (input && checkbox) {
        input.type = checkbox.checked ? 'text' : 'password';
    }
}

function guardarTokenGitHub() {
    const input = document.getElementById('githubTokenInput');
    const token = input ? input.value.trim() : '';
    
    if (!token) {
        mostrarNotificacion('‚ùå Ingrese un token', 'error');
        return;
    }
    
    if (!token.startsWith('ghp_')) {
        mostrarNotificacion('‚ùå Token inv√°lido. Debe comenzar con "ghp_"', 'error');
        return;
    }
    
    // Guardar token
    githubToken = token;
    localStorage.setItem('github_token', token);
    
    mostrarNotificacion('‚úÖ Token guardado correctamente', 'success');
    actualizarInfoGitHub();
}

function probarTokenGitHub() {
    const input = document.getElementById('githubTokenInput');
    const token = input ? input.value.trim() : githubToken;
    
    if (!token) {
        mostrarNotificacion('‚ùå No hay token configurado', 'error');
        return;
    }
    
    mostrarNotificacion('üîç Probando conexi√≥n...', 'info');
    
    // Probar conexi√≥n
    fetch('https://api.github.com/user', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => {
        if (response.ok) {
            mostrarNotificacion('‚úÖ Conexi√≥n exitosa con GitHub', 'success');
        } else {
            mostrarNotificacion('‚ùå Token inv√°lido o sin permisos', 'error');
        }
    })
    .catch(() => {
        mostrarNotificacion('‚ùå Error de conexi√≥n', 'error');
    });
}

function eliminarTokenGitHub() {
    if (confirm('¬øEliminar el token de GitHub?\n\nNo podr√° publicar datos hasta que configure uno nuevo.')) {
        githubToken = null;
        localStorage.removeItem('github_token');
        mostrarNotificacion('‚úÖ Token eliminado', 'success');
        actualizarInfoGitHub();
    }
}

function verificarConexionGitHub() {
    mostrarNotificacion('üîç Verificando conexi√≥n...', 'info');
    
    fetch(GITHUB_DATA_URL, { method: 'HEAD' })
    .then(response => {
        if (response.ok) {
            mostrarNotificacion('‚úÖ Conexi√≥n exitosa con GitHub', 'success');
            document.getElementById('githubStatusText').textContent = 'Conectado ‚úì';
            document.getElementById('githubIcon').textContent = '‚úÖ';
        } else {
            mostrarNotificacion('‚ö†Ô∏è No se pudo acceder a los datos', 'warning');
            document.getElementById('githubStatusText').textContent = 'Error de conexi√≥n';
            document.getElementById('githubIcon').textContent = '‚ùå';
        }
    })
    .catch(() => {
        mostrarNotificacion('‚ùå Error de conexi√≥n', 'error');
        document.getElementById('githubStatusText').textContent = 'Sin conexi√≥n';
        document.getElementById('githubIcon').textContent = 'üî¥';
    });
}

function actualizarInfoGitHub() {
    // Actualizar contadores
    if (document.getElementById('expedientesCount')) {
        document.getElementById('expedientesCount').textContent = expedientes.length;
    }
    
    const ultimaPublicacion = localStorage.getItem('ultima_publicacion');
    if (ultimaPublicacion && document.getElementById('ultimaPublicacion')) {
        const fecha = new Date(ultimaPublicacion);
        document.getElementById('ultimaPublicacion').textContent = 
            `${fecha.toLocaleDateString()} ${fecha.toLocaleTimeString().substring(0,5)}`;
    }
    
    // Verificar token
    if (githubToken && document.getElementById('githubTokenInput')) {
        document.getElementById('githubTokenInput').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
    }
}

function exportarParaUsuarios() {
    // Crear archivo para compartir
    const datos = {
        expedientes: expedientes,
        fecha: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `expedientes_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    mostrarNotificacion('‚úÖ Archivo listo para compartir', 'success');
}

function verDatosPublicados() {
    window.open(GITHUB_DATA_URL, '_blank');
}

// ==============================================
// FUNCIONES B√ÅSICAS DEL SISTEMA
// ==============================================

function mostrarNotificacion(mensaje, tipo = 'info') {
    const notificacion = document.createElement('div');
    notificacion.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background: ${tipo === 'success' ? '#d4edda' : 
                    tipo === 'warning' ? '#fff3cd' : 
                    tipo === 'error' ? '#f8d7da' : '#d1ecf1'};
        color: ${tipo === 'success' ? '#155724' : 
                tipo === 'warning' ? '#856404' : 
                tipo === 'error' ? '#721c24' : '#0c5460'};
        border: 1px solid ${tipo === 'success' ? '#c3e6cb' : 
                          tipo === 'warning' ? '#ffeeba' : 
                          tipo === 'error' ? '#f5c6cb' : '#bee5eb'};
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 9999;
        animation: fadeIn 0.3s;
        max-width: 400px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 10px;
    `;
    
    const icono = tipo === 'success' ? '‚úÖ' : 
                 tipo === 'warning' ? '‚ö†Ô∏è' : 
                 tipo === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
    
    notificacion.innerHTML = `
        <span style="font-size: 20px;">${icono}</span>
        <span>${mensaje}</span>
    `;
    
    document.body.appendChild(notificacion);
    
    setTimeout(() => {
        notificacion.style.animation = 'fadeOut 0.3s';
        setTimeout(() => {
            if (notificacion.parentNode) {
                notificacion.parentNode.removeChild(notificacion);
            }
        }, 300);
    }, 3000);
}

function actualizarTabla() {
    const tbody = document.getElementById('table-body');
    if (!tbody) return;
    
    if (filteredExpedientes.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 50px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üìÇ</div>
                    <h3 style="color: #0078d4;">No hay expedientes cargados</h3>
                    <p style="color: #666; margin-bottom: 30px;">
                        Cargue un archivo Excel o actualice desde la nube.
                    </p>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            üìÅ Cargar Excel
                        </button>
                        <button class="btn btn-success" onclick="cargarDatosDesdeGitHub()">
                            ‚òÅÔ∏è Actualizar desde Nube
                        </button>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    filteredExpedientes.forEach((expediente) => {
        const estadoClass = `badge-${expediente.estado || 'verde'}`;
        const estadoIcon = expediente.estado === 'verde' ? '‚úÖ' : 
                          expediente.estado === 'amarillo' ? '‚ö†Ô∏è' : 
                          expediente.estado === 'naranja' ? 'üü†' : 'üî¥';
        
        const nombreResponsable = extraerNombreSinDocumento(expediente.responsable || 'No asignado');
        const inicial = nombreResponsable.charAt(0).toUpperCase();
        
        html += `
            <tr>
                <td>
                    <strong style="font-size: 16px;">${expediente.nombre || 'Sin nombre'}</strong>
                </td>
                <td>
                    <div style="max-width: 400px;">
                        ${expediente.descripcion || 'Sin descripci√≥n'}
                        ${expediente.fechaApertura ? `<br><small style="color: #666;">Apertura: ${expediente.fechaApertura}</small>` : ''}
                    </div>
                </td>
                <td>
                    <span class="status-badge ${estadoClass}" style="padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.5px; background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.05) 100%); color: #2E7D32; border: 1px solid rgba(76, 175, 80, 0.2);">
                        ${estadoIcon} ${(expediente.estado || 'verde').toUpperCase()}
                    </span>
                </td>
                <td><strong>${expediente.tiempo || 'Sin fecha'}</strong></td>
                <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%); 
                                  color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                                  font-weight: bold; font-size: 12px;">
                            ${inicial}
                        </div>
                        <span style="font-weight: 500;">${nombreResponsable}</span>
                    </div>
                </td>
                <td>${expediente.fechaRevision || 'No disponible'}</td>
                <td>
                    <button class="btn-icon" onclick="verDetalleExpediente(${expediente.id})" title="Ver detalles" style="padding: 8px; border-radius: 6px; background: none; border: 1px solid #ddd; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                        üëÅÔ∏è
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

function actualizarEstadisticas() {
    if (document.getElementById('total-count')) {
        document.getElementById('total-count').textContent = filteredExpedientes.length;
        document.getElementById('verde-count').textContent = filteredExpedientes.filter(e => e.estado === 'verde').length;
        document.getElementById('amarillo-count').textContent = filteredExpedientes.filter(e => e.estado === 'amarillo').length;
        document.getElementById('rojo-count').textContent = filteredExpedientes.filter(e => e.estado === 'rojo').length;
    }
}

function verDetalleExpediente(id) {
    const expediente = expedientes.find(e => e.id === id);
    if (!expediente) return;
    
    const nombreResponsable = extraerNombreSinDocumento(expediente.responsable || 'No asignado');
    
    alert(`üìã DETALLE DEL EXPEDIENTE\n\n` +
          `Expediente: ${expediente.nombre || 'Sin nombre'}\n` +
          `Estado: ${expediente.estado?.toUpperCase() || 'VERDE'}\n` +
          `Tiempo: ${expediente.tiempo || 'Sin fecha'}\n` +
          `Descripci√≥n: ${expediente.descripcion || 'Sin descripci√≥n'}\n` +
          `Responsable: ${nombreResponsable}\n` +
          `Fecha base: ${expediente.fechaRevision || 'No disponible'}\n` +
          `Fecha apertura: ${expediente.fechaApertura || 'No disponible'}`);
}

function cargarConfiguracionGuardada() {
    const configuracionGuardada = localStorage.getItem('dif_configuracion');
    
    if (configuracionGuardada) {
        try {
            const config = JSON.parse(configuracionGuardada);
            expedientes = config.expedientes || [];
            usuariosDisponibles = config.usuariosDisponibles || [];
            historialSubidas = config.historialSubidas || [];
            if (config.fechaReferencia) fechaReferencia = new Date(config.fechaReferencia);
            
            filteredExpedientes = [...expedientes];
            
            actualizarTabla();
            actualizarEstadisticas();
            
        } catch (error) {
            console.log('Error cargando configuraci√≥n:', error);
        }
    }
}

function guardarConfiguracion() {
    const configuracion = {
        expedientes: expedientes,
        usuariosDisponibles: usuariosDisponibles,
        historialSubidas: historialSubidas,
        fechaReferencia: fechaReferencia.toISOString()
    };
    
    localStorage.setItem('dif_configuracion', JSON.stringify(configuracion));
    mostrarNotificacion('Configuraci√≥n guardada', 'success');
}

// ==============================================
// INICIALIZACI√ìN COMPLETA
// ==============================================

document.addEventListener('DOMContentLoaded', function() {
    // Cargar configuraci√≥n local
    cargarConfiguracionGuardada();
    
    // Configurar evento de b√∫squeda
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            
            if (!searchTerm) {
                filteredExpedientes = [...expedientes];
            } else {
                filteredExpedientes = expedientes.filter(exp => {
                    const nombreEnExpediente = extraerNombreSinDocumento(exp.responsable || '');
                    
                    return exp.nombre?.toLowerCase().includes(searchTerm) ||
                           exp.descripcion?.toLowerCase().includes(searchTerm) ||
                           nombreEnExpediente.toLowerCase().includes(searchTerm);
                });
            }
            
            actualizarTabla();
            actualizarEstadisticas();
        });
    }
    
    // Inicializar sistema GitHub
    inicializarSistemaGitHub();
    
    // Verificar si hay usuario guardado
    const usuarioGuardado = localStorage.getItem('dif_documento_usuario');
    if (usuarioGuardado) {
        funcionarioActual = usuarioGuardado;
        
        if (usuarioGuardado === 'Administrador') {
            document.getElementById('userNameDisplay').style.display = 'block';
            document.getElementById('userNameDisplay').textContent = 'üëë Administrador';
        } else {
            document.getElementById('userNameDisplay').style.display = 'block';
            document.getElementById('userNameDisplay').textContent = `üë§ ${usuarioGuardado}`;
        }
    } else {
        // Pedir documento al usuario
        setTimeout(() => {
            pedirDocumentoUsuario();
        }, 1000);
    }
    
    // Verificar conexi√≥n peri√≥dicamente
    setInterval(() => {
        if (navigator.onLine) {
            verificarActualizacionesGitHub();
        }
    }, 300000); // Cada 5 minutos
});

function pedirDocumentoUsuario() {
    const modalHTML = `
        <div class="modal-overlay" style="display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); align-items: center; justify-content: center; z-index: 1000;">
            <div class="modal" style="background: white; border-radius: 15px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);">
                <div class="modal-header" style="background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%); color: white; padding: 25px; border-radius: 15px 15px 0 0;">
                    <h2 style="display: flex; align-items: center; gap: 10px; margin-bottom: 0;">üîë Acceso Funcionario</h2>
                </div>
                <div class="modal-content" style="padding: 30px;">
                    <div style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üë§</div>
                        <h3>Bienvenido al Sistema de Expedientes</h3>
                        <p style="color: #666; margin-bottom: 20px;">
                            Para acceder como funcionario, ingrese su n√∫mero de documento.<br>
                            Para acceso de administrador, haga clic en el bot√≥n inferior.
                        </p>
                        
                        <div style="margin: 20px 0;">
                            <input type="text" id="documentoInput" 
                                   placeholder="Ej: 12345678" 
                                   style="width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 18px; text-align: center;">
                        </div>
                        
                        <div id="errorDocumento" style="color: #dc3545; margin: 10px 0; display: none;">
                            ‚ùå Documento no encontrado
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <button class="btn btn-success" onclick="validarDocumentoUsuario()" style="padding: 12px 30px; background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                ‚úÖ Ver mis expedientes
                            </button>
                        </div>
                        
                        <hr style="margin: 30px 0; border: none; border-top: 1px solid #e0e0e0;">
                        
                        <div>
                            <p style="color: #666; margin-bottom: 15px;">Acceso para administradores:</p>
                            <button class="btn btn-primary" onclick="mostrarLoginAdmin()" style="padding: 12px 30px; background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                üëë Acceso Administrador
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const div = document.createElement('div');
    div.id = 'modalDocumento';
    div.innerHTML = modalHTML;
    document.body.appendChild(div);
}

function validarDocumentoUsuario() {
    const documento = document.getElementById('documentoInput').value.trim();
    const errorDiv = document.getElementById('errorDocumento');
    
    if (!documento) {
        errorDiv.innerHTML = '‚ùå Por favor, ingrese su documento';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Si es admin, acceso directo
    if (documento === 'admin123' || documento === 'Extensiva2026') {
        funcionarioActual = 'Administrador';
        localStorage.setItem('dif_documento_usuario', 'Administrador');
        localStorage.setItem('dif_documento_identificacion', documento);
        
        document.getElementById('modalDocumento').remove();
        document.getElementById('userNameDisplay').style.display = 'block';
        document.getElementById('userNameDisplay').textContent = 'üëë Administrador';
        
        configurarBotonesGitHub();
        return;
    }
    
    // Buscar funcionario por documento
    let funcionarioEncontrado = null;
    
    for (let i = 0; i < expedientes.length; i++) {
        const exp = expedientes[i];
        
        if (exp.responsable && exp.responsable.includes(documento)) {
            funcionarioEncontrado = exp;
            break;
        }
        
        const docEnExpediente = extraerDocumentoDeResponsable(exp.responsable);
        if (docEnExpediente && docEnExpediente === documento) {
            funcionarioEncontrado = exp;
            break;
        }
    }
    
    if (!funcionarioEncontrado) {
        errorDiv.innerHTML = '‚ùå Documento no encontrado en el sistema';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Guardar el nombre limpio
    const nombreEncontrado = extraerNombreSinDocumento(funcionarioEncontrado.responsable);
    funcionarioActual = nombreEncontrado;
    localStorage.setItem('dif_documento_usuario', nombreEncontrado);
    localStorage.setItem('dif_documento_identificacion', documento);
    
    // Cerrar modal
    document.getElementById('modalDocumento').remove();
    
    // Mostrar nombre del usuario
    document.getElementById('userNameDisplay').style.display = 'block';
    document.getElementById('userNameDisplay').textContent = `üë§ ${nombreEncontrado}`;
    
    // Filtrar expedientes para este usuario
    filteredExpedientes = expedientes.filter(exp => {
        const nombreEnExpediente = extraerNombreSinDocumento(exp.responsable);
        return nombreEnExpediente === nombreEncontrado;
    });
    
    actualizarTabla();
    actualizarEstadisticas();
    
    // Configurar botones GitHub
    configurarBotonesGitHub();
}

function ingresarComoAdmin() {
    mostrarLoginAdmin();
    const password = prompt('Ingrese la contrase√±a de administrador:');
    
    if (password === 'Extensiva2026') {
        funcionarioActual = 'Administrador';
        localStorage.setItem('dif_documento_usuario', 'Administrador');
        localStorage.setItem('dif_documento_identificacion', 'admin');
        
        const modal = document.getElementById('modalDocumento');
        if (modal) modal.remove();
        
        document.getElementById('userNameDisplay').style.display = 'block';
        document.getElementById('userNameDisplay').textContent = 'üëë Administrador';
        
        // Mostrar todos los expedientes para admin
        filteredExpedientes = [...expedientes];
        actualizarTabla();
        actualizarEstadisticas();
        
        configurarBotonesGitHub();
        
        mostrarNotificacion('‚úÖ Ingres√≥ como Administrador', 'success');
    } else {
        alert('‚ùå Contrase√±a incorrecta');
    }
}

// ==============================================
// FUNCIONES DE ADMINISTRACI√ìN B√ÅSICAS
// ==============================================

function mostrarLoginAdmin() {
    ingresarComoAdmin();
}

function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    if (!input) return;
    
    if (input.type === 'password') {
        input.type = 'text';
    } else {
        input.type = 'password';
    }
}

function cambiarTabAdmin(tabId) {
    // Ocultar todos los tabs
    document.querySelectorAll('#configModal .tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // Desactivar todos los botones
    document.querySelectorAll('#configModal .tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Mostrar tab seleccionado
    const tabElement = document.getElementById(`tab-${tabId}`);
    if (tabElement) {
        tabElement.style.display = 'block';
    }
    
    // Activar bot√≥n seleccionado
    const btnElement = document.querySelector(`#configModal .tab-btn[onclick*="${tabId}"]`);
    if (btnElement) {
        btnElement.classList.add('active');
    }
    
    // Si es la pesta√±a de GitHub, actualizar info
    if (tabId === 'github') {
        actualizarInfoGitHub();
    }
}

function cerrarModalConfiguracion() {
    document.getElementById('configModal').style.display = 'none';
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const fileName = file.name.toLowerCase();
    const esExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
    const esCSV = fileName.endsWith('.csv');
    
    if (!esExcel && !esCSV) {
        mostrarNotificacion('Suba Excel o CSV', 'error');
        return;
    }
    
    archivoCargado = file;
    
    const fileInfoDiv = document.getElementById('fileInfo');
    const fileNameSpan = document.getElementById('fileName');
    const fileSizeSpan = document.getElementById('fileSize');
    const fileTypeSpan = document.getElementById('fileType');
    
    if (fileInfoDiv) fileInfoDiv.style.display = 'flex';
    if (fileNameSpan) fileNameSpan.textContent = file.name;
    if (fileSizeSpan) fileSizeSpan.textContent = `Tama√±o: ${(file.size / 1024).toFixed(1)} KB`;
    if (fileTypeSpan) fileTypeSpan.textContent = `Tipo: ${esExcel ? 'Excel' : 'CSV'}`;
    
    mostrarNotificacion(`Archivo cargado: ${file.name}`, 'success');
}

function procesarArchivo() {
    if (!archivoCargado) {
        mostrarNotificacion('No hay archivo', 'warning');
        return;
    }
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            // Procesar Excel
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            
            if (jsonData.length < 2) {
                throw new Error('Archivo vac√≠o');
            }
            
            const headers = jsonData[0];
            const nuevosExpedientes = [];
            
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length === 0) continue;
                
                // Extraer datos b√°sicos
                const expediente = {
                    id: Date.now() + i,
                    nombre: row[0] || `Expediente ${i}`,
                    responsable: row[1] || 'No asignado',
                    fechaApertura: row[2] || '',
                    estado: 'verde',
                    tiempo: 'Sin fecha',
                    descripcion: 'Cargado desde Excel',
                    fechaRevision: row[2] || ''
                };
                
                nuevosExpedientes.push(expediente);
            }
            
            if (nuevosExpedientes.length > 0) {
                expedientes = nuevosExpedientes;
                filteredExpedientes = [...expedientes];
                
                actualizarTabla();
                actualizarEstadisticas();
                guardarConfiguracion();
                
                mostrarNotificacion(`‚úÖ ${nuevosExpedientes.length} expedientes cargados`, 'success');
                
                // Actualizar botones GitHub
                configurarBotonesGitHub();
            }
            
        } catch (error) {
            console.error('Error procesando archivo:', error);
            mostrarNotificacion('‚ùå Error procesando archivo', 'error');
        }
    };
    
    reader.readAsArrayBuffer(archivoCargado);
}

function exportarExcel() {
    if (expedientes.length === 0) {
        mostrarNotificacion('No hay datos para exportar', 'warning');
        return;
    }
    
    try {
        const ws = XLSX.utils.json_to_sheet(expedientes.map(exp => ({
            'Expediente': exp.nombre,
            'Responsable': exp.responsable,
            'Fecha Apertura': exp.fechaApertura,
            'Estado': exp.estado,
            'Descripci√≥n': exp.descripcion
        })));
        
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Expedientes");
        
        const fecha = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `Expedientes_DIF_${fecha}.xlsx`);
        
        mostrarNotificacion('Excel exportado', 'success');
        
    } catch (error) {
        mostrarNotificacion('Error exportando', 'error');
    }
}

// ==============================================
// INICIALIZACI√ìN FINAL
// ==============================================

// A√±adir animaciones CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
    
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    .verde { color: #2E7D32; }
    .amarillo { color: #F57C00; }
    .rojo { color: #C62828; }
`;
document.head.appendChild(style);

// Escuchar eventos de conexi√≥n
window.addEventListener('online', () => {
    actualizarIndicadorEstado('conectado', null);
    verificarActualizacionesGitHub();
});

window.addEventListener('offline', () => {
    actualizarIndicadorEstado('offline', null);
});


// ==============================================
// FUNCIONES PARA USUARIOS
// ==============================================

function cargarListaUsuarios() {
    const userList = document.getElementById('userList');
    if (!userList) return;
    
    if (usuariosDisponibles.length === 0) {
        userList.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #666;">
                <p>No hay usuarios registrados.</p>
                <p>Cargue un archivo de expedientes primero.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    usuariosDisponibles.forEach((usuario) => {
        const nombreLimpio = extraerNombreSinDocumento(usuario.nombre || '');
        const expedientesUsuario = expedientes.filter(e => {
            const nombreEnExpediente = extraerNombreSinDocumento(e.responsable || '');
            return nombreEnExpediente === nombreLimpio;
        });
        const vencidos = expedientesUsuario.filter(e => e.estado === 'rojo').length;
        
        html += `
            <div class="user-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; transition: background 0.2s;">
                <div class="user-info" style="display: flex; align-items: center; gap: 15px; flex: 1;">
                    <input type="checkbox" id="user-checkbox-${usuario.id || i}" ${usuario.activo ? 'checked' : ''} 
                           onchange="toggleUsuarioActivo(${usuario.id || i})">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%); 
                               color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                               font-weight: bold; font-size: 16px;">
                        ${nombreLimpio.charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <h4 style="margin: 0; font-size: 16px;">${nombreLimpio}</h4>
                        <p style="margin: 2px 0 0 0; font-size: 14px; color: #666;">${usuario.email || 'Sin correo'}</p>
                        <p style="margin: 2px 0 0 0; font-size: 12px; color: #888;">
                            Expedientes: ${expedientesUsuario.length} 
                            ${vencidos > 0 ? `‚Ä¢ üî¥ ${vencidos} vencidos` : ''}
                        </p>
                    </div>
                </div>
                <div class="user-actions" style="display: flex; gap: 10px;">
                    <button class="btn-icon" onclick="editarUsuario(${usuario.id || i})" title="Editar" style="padding: 8px; border-radius: 6px; background: none; border: 1px solid #ddd; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                        ‚úèÔ∏è
                    </button>
                    <button class="btn-icon" onclick="eliminarUsuario(${usuario.id || i})" title="Eliminar" style="padding: 8px; border-radius: 6px; background: none; border: 1px solid #ddd; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        `;
    });
    
    userList.innerHTML = html;
}

function toggleUsuarioActivo(id) {
    const usuario = usuariosDisponibles.find(u => u.id === id);
    if (usuario) {
        usuario.activo = !usuario.activo;
        guardarConfiguracion();
        mostrarNotificacion(`Usuario ${usuario.activo ? 'activado' : 'desactivado'}`, 'success');
    }
}

function agregarUsuario() {
    const nombre = prompt('Nombre del usuario:');
    if (!nombre) return;
    
    const email = prompt('Correo electr√≥nico:');
    
    const nuevoUsuario = {
        id: Date.now(),
        nombre: nombre,
        email: email || `${nombre.toLowerCase().replace(/\s+/g, '.')}@dif.gob.mx`,
        activo: true,
        origen: 'manual'
    };
    
    usuariosDisponibles.push(nuevoUsuario);
    
    cargarListaUsuarios();
    guardarConfiguracion();
    mostrarNotificacion('Usuario agregado', 'success');
}

function editarUsuario(id) {
    const usuario = usuariosDisponibles.find(u => u.id === id);
    if (!usuario) return;
    
    const nuevoNombre = prompt('Nuevo nombre:', usuario.nombre);
    if (!nuevoNombre) return;
    
    const nuevoEmail = prompt('Nuevo correo:', usuario.email || '');
    
    usuario.nombre = nuevoNombre;
    usuario.email = nuevoEmail;
    
    cargarListaUsuarios();
    guardarConfiguracion();
    mostrarNotificacion('Usuario actualizado', 'success');
}

function eliminarUsuario(id) {
    if (!confirm('¬øEliminar este usuario?')) return;
    
    usuariosDisponibles = usuariosDisponibles.filter(u => u.id !== id);
    
    cargarListaUsuarios();
    guardarConfiguracion();
    mostrarNotificacion('Usuario eliminado', 'success');
}

function eliminarTodosUsuarios() {
    if (!confirm('¬øEliminar TODOS los usuarios?')) return;
    
    usuariosDisponibles = [];
    
    cargarListaUsuarios();
    guardarConfiguracion();
    mostrarNotificacion('Todos los usuarios eliminados', 'success');
}

// ==============================================
// FUNCIONES PARA NOTIFICACIONES
// ==============================================

function mostrarModalNotificaciones() {
    // Crear modal de notificaciones
    const modalHTML = `
        <div class="modal-overlay" style="display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); align-items: center; justify-content: center; z-index: 1000;">
            <div class="modal" style="background: white; border-radius: 15px; width: 90%; max-width: 900px; max-height: 80vh; overflow-y: auto; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);">
                <div class="modal-header" style="background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%); color: white; padding: 25px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="display: flex; align-items: center; gap: 10px; margin-bottom: 0;">üìß Sistema de Notificaciones</h2>
                    <button class="close-modal" onclick="cerrarModalNotificaciones()" style="background: none; border: none; color: white; font-size: 28px; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.3s;">&times;</button>
                </div>
                <div class="modal-content" style="padding: 30px;" id="notificacionesContent">
                    <div class="notificaciones-panel" style="padding: 20px;">
                        <div class="tabs-notificaciones" style="display: flex; border-bottom: 1px solid #dee2e6; margin-bottom: 20px;">
                            <button class="tab-btn active" onclick="cambiarTabNotificacion('enviar')" style="padding: 12px 20px; background: none; border: none; border-bottom: 3px solid #0078d4; cursor: pointer; font-weight: 600; color: #0078d4; transition: all 0.3s;">
                                üì§ Enviar
                            </button>
                            <button class="tab-btn" onclick="cambiarTabNotificacion('historial')" style="padding: 12px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: #666; transition: all 0.3s;">
                                üìã Historial
                            </button>
                        </div>
                        
                        <div id="tab-notif-enviar" class="tab-content active">
                            <div style="margin-bottom: 20px;">
                                <h3>üìß Enviar Notificaciones</h3>
                                <p style="color: #666;">Env√≠e notificaciones a los usuarios</p>
                            </div>
                            
                            <div class="form-group">
                                <label>üìù Asunto:</label>
                                <input type="text" id="asuntoNotificacion" 
                                       value="üìã Seguimiento de Expedientes DIF"
                                       style="width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; margin-top: 5px;">
                            </div>
                            
                            <div class="form-group">
                                <label>üí¨ Mensaje:</label>
                                <textarea id="mensajeNotificacion" rows="6" style="width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; margin-top: 5px;">Estimado/a colega,

Le informamos sobre el estado actual de los expedientes bajo su responsabilidad.

Por favor, revise los expedientes que se encuentran en estado de alerta o vencidos.

Atentamente,
Divisi√≥n de Fiscalizaci√≥n y Liquidaci√≥n Tributaria Extensiva</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>üë• Destinatarios:</label>
                                <div id="listaUsuariosNotificacion" style="margin-top: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px; background: #f8f9fa;">
                                    ${generarListaUsuariosNotificacion()}
                                </div>
                            </div>
                            
                            <div class="modal-footer" style="padding: 20px 0; margin-top: 30px; display: flex; justify-content: flex-end; gap: 15px;">
                                <button class="btn btn-success" onclick="enviarNotificacionesSimuladas()" style="padding: 14px 28px; background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 10px;">
                                    üì§ Enviar Notificaciones
                                </button>
                                <button class="btn" onclick="cerrarModalNotificaciones()" style="padding: 14px 28px; background: #6c757d; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                        
                        <div id="tab-notif-historial" class="tab-content" style="display: none;">
                            <div class="form-group">
                                <h4>üìã Historial de Notificaciones</h4>
                                <div style="margin-top: 15px; display: flex; gap: 10px;">
                                    <button class="btn btn-small" onclick="actualizarHistorialNotificaciones()" style="padding: 6px 12px; font-size: 14px; border-radius: 6px; background: #0078d4; color: white; border: none; cursor: pointer;">
                                        üîÑ Actualizar
                                    </button>
                                    <button class="btn btn-small btn-danger" onclick="limpiarHistorialNotificaciones()" style="padding: 6px 12px; font-size: 14px; border-radius: 6px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; cursor: pointer;">
                                        üóëÔ∏è Limpiar
                                    </button>
                                </div>
                                
                                <div id="listaHistorial" style="margin-top: 20px; max-height: 400px; overflow-y: auto;">
                                    ${generarListaHistorialNotificaciones()}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const div = document.createElement('div');
    div.id = 'modalNotificaciones';
    div.innerHTML = modalHTML;
    document.body.appendChild(div);
}

function cerrarModalNotificaciones() {
    const modal = document.getElementById('modalNotificaciones');
    if (modal) modal.remove();
}

function cambiarTabNotificacion(tabId) {
    // Ocultar todos los tabs
    document.querySelectorAll('#notificacionesContent .tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // Desactivar todos los botones
    document.querySelectorAll('#notificacionesContent .tab-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.style.borderBottomColor = 'transparent';
        btn.style.color = '#666';
    });
    
    // Mostrar tab seleccionado
    const tabElement = document.getElementById(`tab-notif-${tabId}`);
    if (tabElement) {
        tabElement.style.display = 'block';
    }
    
    // Activar bot√≥n seleccionado
    const btnElement = document.querySelector(`#notificacionesContent .tab-btn[onclick*="${tabId}"]`);
    if (btnElement) {
        btnElement.classList.add('active');
        btnElement.style.borderBottomColor = '#0078d4';
        btnElement.style.color = '#0078d4';
    }
}

function generarListaUsuariosNotificacion() {
    if (usuariosDisponibles.length === 0) {
        return `
            <div style="text-align: center; padding: 40px; color: #666;">
                <p>No hay usuarios registrados.</p>
                <p>Cargue un archivo de expedientes primero.</p>
            </div>
        `;
    }
    
    let html = '';
    usuariosDisponibles.forEach((usuario, index) => {
        const nombreUsuario = extraerNombreSinDocumento(usuario.nombre || '');
        
        html += `
            <div class="usuario-notificacion-item" style="display: flex; align-items: center; padding: 10px; margin-bottom: 5px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                <div class="usuario-notificacion-info" style="display: flex; align-items: center; gap: 12px; flex: 1;">
                    <input type="checkbox" id="usuario-${index}" 
                           class="usuario-checkbox" data-id="${index}"
                           data-nombre="${nombreUsuario}" data-email="${usuario.email || ''}">
                    <div class="usuario-avatar" style="width: 40px; height: 40px; background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px;">
                        ${nombreUsuario.charAt(0).toUpperCase()}
                    </div>
                    <div class="usuario-detalles">
                        <h4 style="margin: 0; font-size: 16px; color: #333;">${nombreUsuario}</h4>
                        <p style="margin: 2px 0 0 0; font-size: 14px; color: #666;">üìß ${usuario.email || 'Sin correo'}</p>
                    </div>
                </div>
            </div>
        `;
    });
    
    return html;
}

function generarListaHistorialNotificaciones() {
    const historial = JSON.parse(localStorage.getItem('historial_notificaciones') || '[]');
    
    if (historial.length === 0) {
        return `
            <div style="text-align: center; padding: 40px; color: #666;">
                <p>No hay historial de notificaciones.</p>
                <p>Las notificaciones enviadas aparecer√°n aqu√≠.</p>
            </div>
        `;
    }
    
    let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
    
    historial.forEach((notif, index) => {
        const fecha = new Date(notif.fecha || Date.now());
        const fechaFormateada = fecha.toLocaleDateString() + ' ' + fecha.toLocaleTimeString().substring(0, 5);
        
        html += `
            <div class="historial-item" style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #0078d4; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            üìß
                            <strong style="font-size: 16px;">${notif.asunto || 'Notificaci√≥n'}</strong>
                        </div>
                        <div style="color: #666; font-size: 14px;">
                            <div>üìÖ ${fechaFormateada}</div>
                            <div>üë• ${notif.destinatarios || 0} destinatarios</div>
                            <div>üì® ${notif.enviados || 0} enviados</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    return html;
}

function enviarNotificacionesSimuladas() {
    const asunto = document.getElementById('asuntoNotificacion').value;
    const mensaje = document.getElementById('mensajeNotificacion').value;
    
    if (!asunto || !mensaje) {
        mostrarNotificacion('Complete el asunto y mensaje', 'warning');
        return;
    }
    
    // Contar checkboxes seleccionados
    const checkboxes = document.querySelectorAll('.usuario-checkbox:checked');
    if (checkboxes.length === 0) {
        mostrarNotificacion('Seleccione al menos un destinatario', 'warning');
        return;
    }
    
    // Simular env√≠o
    mostrarNotificacion(`üì§ Enviando a ${checkboxes.length} destinatarios...`, 'info');
    
    setTimeout(() => {
        // Guardar en historial
        const historial = JSON.parse(localStorage.getItem('historial_notificaciones') || '[]');
        historial.unshift({
            asunto: asunto,
            destinatarios: checkboxes.length,
            enviados: checkboxes.length,
            fecha: new Date().toISOString()
        });
        
        // Mantener solo √∫ltimos 50 registros
        if (historial.length > 50) historial.length = 50;
        
        localStorage.setItem('historial_notificaciones', JSON.stringify(historial));
        
        // Actualizar estad√≠sticas
        actualizarEstadisticasNotificaciones();
        
        mostrarNotificacion(`‚úÖ Notificaciones enviadas a ${checkboxes.length} usuarios`, 'success');
        cerrarModalNotificaciones();
    }, 1500);
}

function actualizarHistorialNotificaciones() {
    const lista = document.getElementById('listaHistorial');
    if (lista) {
        lista.innerHTML = generarListaHistorialNotificaciones();
    }
}

function limpiarHistorialNotificaciones() {
    if (confirm('¬øEliminar todo el historial de notificaciones?')) {
        localStorage.removeItem('historial_notificaciones');
        actualizarHistorialNotificaciones();
        mostrarNotificacion('Historial eliminado', 'success');
    }
}

function actualizarEstadisticasNotificaciones() {
    const historial = JSON.parse(localStorage.getItem('historial_notificaciones') || '[]');
    
    if (document.getElementById('totalUsuariosNotificacion')) {
        document.getElementById('totalUsuariosNotificacion').textContent = usuariosDisponibles.length;
    }
    
    if (document.getElementById('totalNotificacionesEnviadas')) {
        document.getElementById('totalNotificacionesEnviadas').textContent = historial.length;
    }
    
    if (document.getElementById('expedientesVencidos')) {
        document.getElementById('expedientesVencidos').textContent = expedientes.filter(e => e.estado === 'rojo').length;
    }
    
    if (document.getElementById('ultimaNotificacion') && historial.length > 0) {
        const fecha = new Date(historial[0].fecha);
        document.getElementById('ultimaNotificacion').textContent = fecha.toLocaleDateString();
    }
}

// ==============================================
// FUNCIONES PARA HISTORIAL Y BACKUP
// ==============================================

function cargarHistorialSubidas() {
    const contenedor = document.getElementById('historialSubidas');
    if (!contenedor) return;
    
    if (historialSubidas.length === 0) {
        contenedor.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
                <p>No hay historial de subidas.</p>
                <p>Las subidas de archivos aparecer√°n aqu√≠.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
    
    historialSubidas.forEach((subida) => {
        const fecha = new Date(subida.fecha || Date.now());
        const fechaFormateada = fecha.toLocaleDateString() + ' ' + fecha.toLocaleTimeString().substring(0, 5);
        
        html += `
            <div class="historial-subida-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 10px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                        üìÅ
                        <strong style="font-size: 14px;">${subida.nombreArchivo || 'Archivo'}</strong>
                    </div>
                    <div style="color: #666; font-size: 12px;">
                        <div>üìÖ ${fechaFormateada} ‚Ä¢ üë§ ${subida.usuario || 'Sistema'}</div>
                        <div>üìä ${subida.cantidadExpedientes || 0} expedientes</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    contenedor.innerHTML = html;
}

function exportarHistorialExcel() {
    if (historialSubidas.length === 0) {
        mostrarNotificacion('No hay historial para exportar', 'warning');
        return;
    }
    
    try {
        const ws = XLSX.utils.json_to_sheet(historialSubidas.map(subida => ({
            'Fecha': new Date(subida.fecha || Date.now()).toLocaleString(),
            'Archivo': subida.nombreArchivo || '',
            'Expedientes': subida.cantidadExpedientes || 0,
            'Usuario': subida.usuario || 'Sistema'
        })));
        
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Historial");
        
        const fecha = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `Historial_Subidas_${fecha}.xlsx`);
        
        mostrarNotificacion('Historial exportado a Excel', 'success');
        
    } catch (error) {
        mostrarNotificacion(`Error exportando: ${error.message}`, 'error');
    }
}

function limpiarHistorialSubidas() {
    if (confirm('¬øEliminar todo el historial de subidas?')) {
        historialSubidas = [];
        guardarConfiguracion();
        cargarHistorialSubidas();
        mostrarNotificacion('Historial eliminado', 'success');
    }
}

function descargarBackup() {
    const backupData = {
        expedientes: expedientes,
        usuariosDisponibles: usuariosDisponibles,
        historialSubidas: historialSubidas,
        fechaReferencia: fechaReferencia.toISOString(),
        fechaBackup: new Date().toISOString(),
        version: '1.0'
    };
    
    const dataStr = JSON.stringify(backupData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `backup_expedientes_${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    mostrarNotificacion('Backup descargado exitosamente', 'success');
}

function handleBackupUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const fileName = file.name.toLowerCase();
    if (!fileName.endsWith('.json')) {
        mostrarNotificacion('Solo se aceptan archivos JSON', 'error');
        return;
    }
    
    const fileInfoDiv = document.getElementById('backupFileInfo');
    const fileNameSpan = document.getElementById('backupFileName');
    const fileSizeSpan = document.getElementById('backupFileSize');
    const restaurarBtn = document.getElementById('restaurarBtn');
    
    if (fileInfoDiv) fileInfoDiv.style.display = 'flex';
    if (fileNameSpan) fileNameSpan.textContent = file.name;
    if (fileSizeSpan) fileSizeSpan.textContent = `Tama√±o: ${(file.size / 1024).toFixed(1)} KB`;
    
    archivoBackup = file;
    
    mostrarNotificacion(`Backup cargado: ${file.name}`, 'success');
}

function eliminarBackupFile() {
    archivoBackup = null;
    const fileInput = document.getElementById('backupFileInput');
    const fileInfoDiv = document.getElementById('backupFileInfo');
    
    if (fileInput) fileInput.value = '';
    if (fileInfoDiv) fileInfoDiv.style.display = 'none';
    
    mostrarNotificacion('Backup eliminado', 'success');
}

function restaurarBackup() {
    if (!archivoBackup) {
        mostrarNotificacion('No hay archivo de backup', 'warning');
        return;
    }
    
    if (!confirm('¬øRestaurar backup?\n\nEsta acci√≥n sobrescribir√° todos los datos actuales.')) {
        return;
    }
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const backupData = JSON.parse(e.target.result);
            
            if (!backupData.expedientes || !Array.isArray(backupData.expedientes)) {
                throw new Error('Estructura de backup inv√°lida');
            }
            
            expedientes = backupData.expedientes || [];
            usuariosDisponibles = backupData.usuariosDisponibles || [];
            historialSubidas = backupData.historialSubidas || [];
            
            if (backupData.fechaReferencia) {
                fechaReferencia = new Date(backupData.fechaReferencia);
            }
            
            filteredExpedientes = [...expedientes];
            
            actualizarTabla();
            actualizarEstadisticas();
            actualizarInfoBackup();
            
            guardarConfiguracion();
            
            mostrarNotificacion(`‚úÖ Backup restaurado: ${expedientes.length} expedientes`, 'success');
            
            eliminarBackupFile();
            
        } catch (error) {
            mostrarNotificacion(`‚ùå Error restaurando backup: ${error.message}`, 'error');
        }
    };
    
    reader.onerror = function() {
        mostrarNotificacion('‚ùå Error leyendo archivo de backup', 'error');
    };
    
    reader.readAsText(archivoBackup, 'UTF-8');
}

function actualizarInfoBackup() {
    if (document.getElementById('totalExpedientesBackup')) {
        document.getElementById('totalExpedientesBackup').textContent = expedientes.length;
    }
    
    if (document.getElementById('totalUsuariosBackup')) {
        document.getElementById('totalUsuariosBackup').textContent = usuariosDisponibles.length;
    }
    
    if (document.getElementById('historialSubidasCount')) {
        document.getElementById('historialSubidasCount').textContent = historialSubidas.length;
    }
    
    if (document.getElementById('ultimaSubida') && historialSubidas.length > 0) {
        const ultima = historialSubidas[0];
        const fecha = new Date(ultima.fecha || Date.now());
        document.getElementById('ultimaSubida').textContent = fecha.toLocaleDateString();
    }
}

// ==============================================
// FUNCIONES DE ADMINISTRACI√ìN COMPLETAS
// ==============================================

function validarAccesoAdmin() {
    const passwordInput = document.getElementById('adminPassword');
    const errorDiv = document.getElementById('adminPasswordError');
    const password = passwordInput ? passwordInput.value : '';
    
    if (password === adminConfig.password) {
        adminConfig.sesionActiva = true;
        adminConfig.inicioSesion = new Date();
        
        localStorage.setItem('dif_sesion_admin', JSON.stringify({
            inicio: adminConfig.inicioSesion,
            activa: true
        }));
        
        cerrarLoginAdmin();
        mostrarModalConfiguracion();
        
    } else {
        if (errorDiv) {
            errorDiv.style.display = 'block';
        }
        if (passwordInput) {
            passwordInput.style.borderColor = '#dc3545';
            passwordInput.value = '';
            passwordInput.focus();
        }
    }
}

function cerrarLoginAdmin() {
    const modal = document.getElementById('adminLoginModal');
    if (modal) modal.style.display = 'none';
}

function mostrarModalConfiguracion() {
    document.getElementById('configModal').style.display = 'flex';
    
    // Inicializar todas las pesta√±as
    cargarListaUsuarios();
    cargarHistorialSubidas();
    actualizarInfoBackup();
    actualizarEstadisticasNotificaciones();
    actualizarInfoGitHub();
    
    cambiarTabAdmin('expedientes');
}

</script>
</body>
</html>
