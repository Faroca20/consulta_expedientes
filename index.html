<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Expedientes - DIF</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        body { 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1300px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header p {
            font-size: 18px;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 25px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-number {
            font-size: 42px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 16px;
            color: #666;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px;
            background: white;
            border-bottom: 1px solid #e9ecef;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .search-box {
            position: relative;
            flex-grow: 1;
            max-width: 400px;
        }
        
        .search-box input {
            width: 100%;
            padding: 14px 20px 14px 50px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            border-color: #0078d4;
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
            outline: none;
        }
        
        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #106ebe 0%, #005a9e 100%);
            box-shadow: 0 6px 15px rgba(0, 120, 212, 0.2);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #388E3C 0%, #2E7D32 100%);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.2);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #FFC107 0%, #FFA000 100%);
            color: white;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #FFA000 0%, #FF8F00 100%);
            box-shadow: 0 6px 15px rgba(255, 193, 7, 0.2);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            box-shadow: 0 6px 15px rgba(220, 53, 69, 0.2);
        }
        
        .table-container {
            padding: 0;
            overflow-x: auto;
        }
        
        .expedientes-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        .expedientes-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px 15px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 3px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .expedientes-table td {
            padding: 20px 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }
        
        .expedientes-table tr:hover td {
            background: #f8fafc;
        }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-badge::before {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .badge-verde {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.05) 100%);
            color: #2E7D32;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }
        
        .badge-verde::before {
            background: #4CAF50;
        }
        
        .badge-amarillo {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%);
            color: #F57C00;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        .badge-amarillo::before {
            background: #FFC107;
        }
        
        .badge-naranja {
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.1) 0%, rgba(255, 152, 0, 0.05) 100%);
            color: #EF6C00;
            border: 1px solid rgba(255, 152, 0, 0.2);
        }
        
        .badge-naranja::before {
            background: #FF9800;
        }
        
        .badge-rojo {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.1) 0%, rgba(244, 67, 54, 0.05) 100%);
            color: #C62828;
            border: 1px solid rgba(244, 67, 54, 0.2);
        }
        
        .badge-rojo::before {
            background: #F44336;
        }
        
        .legend {
            padding: 25px;
            background: linear-gradient(135deg, #f8fafc 0%, #e3f2fd 100%);
            border-top: 2px solid #e9ecef;
        }
        
        .legend h3 {
            color: #0078d4;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(0,0,0,0.1);
        }
        
        .color-verde { background: #4CAF50; }
        .color-amarillo { background: #FFC107; }
        .color-naranja { background: #FF9800; }
        .color-rojo { background: #F44336; }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }
        
        .modal {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.4s;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            color: white;
            padding: 25px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 0;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .close-modal:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .modal-content {
            padding: 30px;
        }
        
        .modal-footer {
            padding: 20px 30px;
            background: #f8f9fa;
            border-radius: 0 0 15px 15px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        .modal-notificaciones {
            max-width: 900px;
        }
        
        .tabs-notificaciones {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab-btn:hover {
            color: #0078d4;
        }
        
        .tab-btn.active {
            color: #0078d4;
            border-bottom-color: #0078d4;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .login-container {
            text-align: center;
            padding: 40px 20px;
        }
        
        .login-icon {
            font-size: 64px;
            margin-bottom: 20px;
            color: #0078d4;
        }
        
        .password-input {
            position: relative;
            margin: 20px 0;
        }
        
        .password-input input {
            width: 100%;
            padding: 14px 50px 14px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            letter-spacing: 3px;
            transition: all 0.3s;
        }
        
        .password-input input:focus {
            border-color: #0078d4;
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
            outline: none;
        }
        
        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 18px;
        }
        
        .notificaciones-panel {
            padding: 20px;
        }
        
        .user-list {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }
        
        .user-item:hover {
            background: #f8f9fa;
        }
        
        .user-item:last-child {
            border-bottom: none;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .user-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }
        
        .user-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 6px;
        }
        
        .btn-icon {
            padding: 8px;
            border-radius: 6px;
            background: none;
            border: 1px solid #ddd;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .btn-icon:hover {
            background: #f0f0f0;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #0078d4;
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
            outline: none;
        }
        
        .file-upload {
            border: 2px dashed #0078d4;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            background: rgba(0, 120, 212, 0.05);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload:hover {
            background: rgba(0, 120, 212, 0.1);
        }
        
        .file-upload input {
            display: none;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .config-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 120, 212, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 100;
            transition: all 0.3s;
        }
        
        .config-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 120, 212, 0.4);
        }
        
        .usuarios-notificacion-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .usuario-notificacion-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        .usuario-notificacion-item:hover {
            background: #f0f7ff;
            border-color: #0078d4;
        }
        
        .usuario-notificacion-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .usuario-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .usuario-detalles h4 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }
        
        .usuario-detalles p {
            margin: 2px 0 0 0;
            font-size: 14px;
            color: #666;
        }
        
        .historial-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #0078d4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .historial-subidas {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .historial-subida-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .user-name-display {
            font-size: 24px;
            font-weight: bold;
            color: #0078d4;
            margin: 20px 0;
            padding: 10px;
            background: #f0f7ff;
            border-radius: 8px;
            text-align: center;
        }
        
        .backup-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 24px; }
            .controls { flex-direction: column; align-items: stretch; }
            .search-box { max-width: 100%; }
            .stats-container { grid-template-columns: 1fr 1fr; }
            .user-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .user-actions { align-self: flex-end; }
        }
        
        @media (max-width: 480px) {
            .stats-container { grid-template-columns: 1fr; }
            .header { padding: 20px; }
            .controls { padding: 15px; }
            .modal { width: 95%; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #0078d4;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #106ebe;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <script>
    const EMAILJS_PUBLIC_KEY = "KlfdPY2IzmTp8MRzH";
    
    (function() {
        try {
            if (typeof emailjs !== 'undefined') {
                emailjs.init(EMAILJS_PUBLIC_KEY);
            }
        } catch (error) {
            console.log("Error:", error);
        }
    })();
    </script>
</head>
<body>
    <!-- Bot√≥n para administrador -->
    <button class="config-button" onclick="mostrarLoginAdmin()" title="Acceso Administrador">
        üîí
    </button>

    <!-- MODAL LOGIN ADMIN -->
    <div id="adminLoginModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2>üîê Acceso Administrador</h2>
                <button class="close-modal" onclick="cerrarLoginAdmin()">&times;</button>
            </div>
            <div class="modal-content">
                <div class="login-container">
                    <div class="login-icon">üëë</div>
                    <h3>Panel de Administraci√≥n</h3>
                    <p style="color: #666; margin-bottom: 20px;">
                        Ingrese la contrase√±a de administrador para continuar.
                    </p>
                    <div class="password-input">
                        <input type="password" id="adminPassword" 
                               placeholder="Contrase√±a de administrador" autocomplete="off">
                        <button class="toggle-password" type="button" 
                                onclick="togglePasswordVisibility('adminPassword')">
                            üëÅÔ∏è
                        </button>
                    </div>
                    <div id="adminPasswordError" style="color: #dc3545; margin: 10px 0; display: none;">
                        ‚ùå Contrase√±a incorrecta.
                    </div>
                    <div style="margin-top: 30px;">
                        <button class="btn btn-primary" onclick="validarAccesoAdmin()">
                            üîë Ingresar como Administrador
                        </button>
                        <button class="btn" onclick="cerrarLoginAdmin()" style="margin-left: 10px;">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CONFIGURACI√ìN -->
    <div id="configModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2>‚öôÔ∏è Panel de Administraci√≥n</h2>
                <button class="close-modal" onclick="cerrarModalConfiguracion()">&times;</button>
            </div>
            <div class="modal-content">
                <div class="tabs-notificaciones">
                    <button class="tab-btn active" onclick="cambiarTabAdmin('expedientes')">üìÅ Expedientes</button>
                    <button class="tab-btn" onclick="cambiarTabAdmin('usuarios')">üë• Usuarios</button>
                    <button class="tab-btn" onclick="cambiarTabAdmin('notificaciones')">üîî Notificaciones</button>
                    <button class="tab-btn" onclick="cambiarTabAdmin('historial')">üìã Historial</button>
                    <button class="tab-btn" onclick="cambiarTabAdmin('backup')">üíæ Copia Seguridad</button>
                </div>
                <div id="tab-expedientes" class="tab-content active">
                    <div class="form-group">
                        <label>üìÅ Cargar Archivo de Expedientes</label>
                        <p style="margin-bottom: 15px; color: #666;">Suba un archivo Excel (.xlsx, .xls) o CSV:</p>
                        <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" onchange="handleFileUpload(event)">
                            <div style="font-size: 48px; margin-bottom: 15px;">üì§</div>
                            <h3 style="color: #0078d4; margin-bottom: 10px;">Haga clic para cargar archivo</h3>
                            <p style="color: #666;">Formatos: Excel (.xlsx, .xls) o CSV</p>
                        </div>
                        <div id="fileInfo" class="file-info" style="display: none;">
                            <div>
                                <strong id="fileName"></strong><br>
                                <span id="fileSize"></span><br>
                                <span id="fileType"></span>
                            </div>
                            <div>
                                <button class="btn btn-small btn-success" onclick="procesarArchivo()" id="procesarBtn">
                                    üìã Cargar al Sistema
                                </button>
                                <button class="btn btn-small btn-danger" onclick="eliminarArchivo()">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        <div id="processingInfo" style="display: none; margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 5px;">
                            <span id="processingText"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>üìÖ Configuraci√≥n de Fechas</label>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <strong>Fecha de referencia actual:</strong>
                            <span id="fechaReferenciaActual" style="background: #f0f0f0; padding: 5px 10px; border-radius: 4px;"></span>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-warning" onclick="cambiarFechaReferencia()">
                                üìÖ Cambiar Fecha
                            </button>
                            <button class="btn btn-success" onclick="usarFechaActual()">
                                üïê Usar Fecha Actual
                            </button>
                            <button class="btn" onclick="recalcularTodosExpedientes()">
                                üîÑ Recalcular
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>‚ö° Acciones</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="exportarExcel()">
                                üì• Exportar a Excel
                            </button>
                            <button class="btn btn-danger" onclick="limpiarDatos()">
                                üóëÔ∏è Limpiar Datos
                            </button>
                        </div>
                    </div>
                </div>
                <div id="tab-usuarios" class="tab-content">
                    <div class="form-group">
                        <label>üë• Gesti√≥n de Usuarios</label>
                        <p style="margin-bottom: 15px; color: #666;">Usuarios detectados autom√°ticamente:</p>
                        <div class="user-list" id="userList"></div>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="agregarUsuario()">
                                ‚ûï Agregar Usuario
                            </button>
                            <button class="btn btn-danger" onclick="eliminarTodosUsuarios()">
                                üóëÔ∏è Eliminar Todos
                            </button>
                        </div>
                    </div>
                </div>
                <div id="tab-notificaciones" class="tab-content">
                    <div class="form-group">
                        <label>üîî Sistema de Notificaciones</label>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="mostrarModalNotificaciones()" style="width: 100%; padding: 20px; font-size: 18px;">
                                üìß Abrir M√≥dulo de Notificaciones
                            </button>
                        </div>
                        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                            <h4>üìä Estad√≠sticas</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                <div style="background: white; padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #0078d4;" id="totalUsuariosNotificacion">0</div>
                                    <div style="color: #666;">Usuarios</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="totalNotificacionesEnviadas">0</div>
                                    <div style="color: #666;">Notificaciones</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #ffc107;" id="expedientesVencidos">0</div>
                                    <div style="color: #666;">Vencidos</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #6c757d;" id="ultimaNotificacion">Nunca</div>
                                    <div style="color: #666;">√öltima</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="tab-historial" class="tab-content">
                    <div class="form-group">
                        <label>üìã Historial de Subidas</label>
                        <div class="historial-subidas" id="historialSubidas">
                            <!-- El historial se cargar√° aqu√≠ -->
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="exportarHistorialExcel()">
                                üì• Exportar Historial a Excel
                            </button>
                            <button class="btn btn-danger" onclick="limpiarHistorialSubidas()">
                                üóëÔ∏è Limpiar Historial
                            </button>
                        </div>
                    </div>
                </div>
                <div id="tab-backup" class="tab-content">
                    <div class="backup-section">
                        <h3>üíæ Sistema de Copia de Seguridad</h3>
                        <p style="color: #666; margin-bottom: 20px;">
                            Realice copias de seguridad de todos los datos del sistema para transferirlos a otro equipo.
                        </p>
                        
                        <div style="margin: 30px 0;">
                            <h4>üì§ Descargar Copia de Seguridad</h4>
                            <p style="color: #666; margin-bottom: 15px;">
                                Descargue un archivo JSON con todos los datos del sistema:
                            </p>
                            <button class="btn btn-success" onclick="descargarBackup()">
                                üíæ Descargar Backup
                            </button>
                        </div>
                        
                        <div style="margin: 30px 0; padding: 20px; background: #e7f3ff; border-radius: 10px;">
                            <h4>üì• Restaurar Copia de Seguridad</h4>
                            <p style="color: #666; margin-bottom: 15px;">
                                Suba un archivo JSON de backup para restaurar todos los datos:
                            </p>
                            <div class="file-upload" onclick="document.getElementById('backupFileInput').click()">
                                <input type="file" id="backupFileInput" accept=".json" onchange="handleBackupUpload(event)">
                                <div style="font-size: 48px; margin-bottom: 15px;">üìÇ</div>
                                <h3 style="color: #0078d4; margin-bottom: 10px;">Haga clic para cargar backup</h3>
                                <p style="color: #666;">Formato: JSON (.json)</p>
                            </div>
                            <div id="backupFileInfo" class="file-info" style="display: none; margin-top: 15px;">
                                <div>
                                    <strong id="backupFileName"></strong><br>
                                    <span id="backupFileSize"></span>
                                </div>
                                <div>
                                    <button class="btn btn-small btn-success" onclick="restaurarBackup()" id="restaurarBtn">
                                        üîÑ Restaurar
                                    </button>
                                    <button class="btn btn-small btn-danger" onclick="eliminarBackupFile()">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                            <h4>üìä Informaci√≥n del Backup</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                <div style="background: white; padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #0078d4;" id="totalExpedientesBackup">0</div>
                                    <div style="color: #666;">Expedientes</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="totalUsuariosBackup">0</div>
                                    <div style="color: #666;">Usuarios</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #ffc107;" id="historialSubidasCount">0</div>
                                    <div style="color: #666;">Subidas</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #6c757d;" id="ultimaSubida">Nunca</div>
                                    <div style="color: #666;">√öltima</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="guardarConfiguracion()">
                    üíæ Guardar
                </button>
                <button class="btn" onclick="cerrarModalConfiguracion()">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL NOTIFICACIONES -->
    <div id="notificacionesModal" class="modal-overlay" style="display: none;">
        <div class="modal modal-notificaciones">
            <div class="modal-header">
                <h2>üìß Sistema de Notificaciones</h2>
                <button class="close-modal" onclick="cerrarModalNotificaciones()">&times;</button>
            </div>
            <div class="modal-content" id="notificacionesContent"></div>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="container" id="mainContent">
        <div class="header">
            <h1>üèõÔ∏è Sistema de Seguimiento de Expedientes</h1>
            <p>Divisi√≥n de Fiscalizaci√≥n y Liquidaci√≥n Tributaria Extensiva</p>
            <!-- Mostrar nombre del funcionario cuando sea usuario -->
            <div id="userNameDisplay" class="user-name-display" style="display: none;"></div>
        </div>
        <div class="stats-container">
            <div class="stat-card"><div class="stat-number" id="total-count">0</div><div class="stat-label">Total</div></div>
            <div class="stat-card"><div class="stat-number verde" id="verde-count">0</div><div class="stat-label verde">En Tiempo</div></div>
            <div class="stat-card"><div class="stat-number amarillo" id="amarillo-count">0</div><div class="stat-label amarillo">Alerta</div></div>
            <div class="stat-card"><div class="stat-number rojo" id="rojo-count">0</div><div class="stat-label rojo">Vencidos</div></div>
        </div>
        <div class="controls">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="search-input" placeholder="Buscar por expediente, responsable o descripci√≥n...">
            </div>
        </div>
        <div class="table-container">
            <table class="expedientes-table">
                <thead>
                    <tr>
                        <th width="12%">Expediente</th>
                        <th width="25%">Descripci√≥n</th>
                        <th width="10%">Estado</th>
                        <th width="12%">Tiempo Restante</th>
                        <th width="12%">Responsable</th>
                        <th width="12%">Fecha Base</th>
                        <th width="5%">Acciones</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
        <div class="legend">
            <h3>üìã Leyenda de Estados</h3>
            <div class="legend-items">
                <div class="legend-item"><div class="legend-color color-verde"></div><div><strong>VERDE</strong><br>En tiempo (4+ y 3 meses)</div></div>
                <div class="legend-item"><div class="legend-color color-amarillo"></div><div><strong>AMARILLO</strong><br>Alerta (2 meses)</div></div>
                <div class="legend-item"><div class="legend-color color-naranja"></div><div><strong>NARANJA</strong><br>Pr√≥ximo (1 mes)</div></div>
                <div class="legend-item"><div class="legend-color color-rojo"></div><div><strong>ROJO</strong><br>Vencido (0 o menos meses)</div></div>
            </div>
        </div>
    </div>

    <script>
        // ==============================================
        // VARIABLES GLOBALES
        // ==============================================
        let expedientes = [];
        let filteredExpedientes = [];
        let archivoCargado = null;
        let archivoBackup = null;
        let usuariosDisponibles = [];
        let usuariosNotificacion = [];
        let historialSubidas = [];
        let funcionarioActual = null;
        
        let adminConfig = {
            password: 'Extensiva2026',
            sesionActiva: false,
            tiempoSesion: 60
        };
        
        let fechaReferencia = new Date('2025-12-18');
        const PERIODO_REVISION_MESES = 4;

        // ==============================================
        // FUNCIONES AUXILIARES
        // ==============================================
        function extraerNombreSinDocumento(responsableCompleto) {
            if (!responsableCompleto) return responsableCompleto;
            
            // Formato 1: "Juan P√©rez - 12345678"
            if (responsableCompleto.includes('-')) {
                const partes = responsableCompleto.split('-');
                return partes[0].trim();
            }
            
            // Formato 2: "Juan P√©rez 12345678"
            const partes = responsableCompleto.split(' ');
            const ultimaParte = partes[partes.length - 1];
            
            // Verificar si la √∫ltima parte es un documento (solo n√∫meros, largo t√≠pico)
            if (/^\d+$/.test(ultimaParte) && ultimaParte.length >= 5) {
                // Es un documento, eliminarlo
                partes.pop();
            }
            
            return partes.join(' ').trim();
        }

        // ==============================================
        // INICIALIZACI√ìN
        // ==============================================
        document.addEventListener('DOMContentLoaded', function() {
            cargarConfiguracionGuardada();
            configurarEventos();
            actualizarDisplayFechaReferencia();
            actualizarInfoBackup();
            actualizarEstadisticasNotificaciones();
            verificarSesionAdminActiva();
            
            // Verificar si el usuario ya ingres√≥
            const usuarioGuardado = localStorage.getItem('dif_documento_usuario');
            if (usuarioGuardado) {
                funcionarioActual = usuarioGuardado;
                if (usuarioGuardado === 'Administrador') {
                    mostrarExpedientesAdmin();
                } else {
                    mostrarExpedientesFuncionario();
                }
            } else {
                // Pedir documento al usuario si no lo ha ingresado
                setTimeout(() => {
                    pedirDocumentoUsuario();
                }, 500);
            }
        });

        function configurarEventos() {
            document.getElementById('search-input').addEventListener('input', filtrarExpedientes);
        }

        // ==============================================
        // SISTEMA PARA FUNCIONARIOS
        // ==============================================
        function pedirDocumentoUsuario() {
            const modalHTML = `
                <div class="modal-overlay" style="display: flex;">
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <h2>üîë Acceso Funcionario</h2>
                            <button class="close-modal" onclick="cerrarModalDocumento()">&times;</button>
                        </div>
                        <div class="modal-content">
                            <div style="text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 20px;">üë§</div>
                                <h3>Bienvenido al Sistema de Expedientes</h3>
                                <p style="color: #666; margin-bottom: 20px;">
                                    Por favor, ingrese su n√∫mero de documento para ver sus expedientes asignados.
                                </p>
                                
                                <div class="form-group">
                                    <input type="text" id="documentoInput" 
                                           placeholder="Ej: 12345678" 
                                           style="text-align: center; font-size: 18px;">
                                </div>
                                
                                <div id="errorDocumento" style="color: #dc3545; margin: 10px 0; display: none;">
                                    ‚ùå Documento no encontrado
                                </div>
                                
                                <div style="margin-top: 30px;">
                                    <button class="btn btn-success" onclick="validarDocumentoUsuario()" style="padding: 12px 30px;">
                                        ‚úÖ Ver mis expedientes
                                    </button>
                                </div>
                                
                                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                                    <p style="color: #888; font-size: 14px;">
                                        ¬øEs administrador? Haga clic en el bot√≥n üîí abajo a la derecha
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const div = document.createElement('div');
            div.innerHTML = modalHTML;
            div.id = 'modalDocumentoUsuario';
            document.body.appendChild(div);
            
            setTimeout(() => {
                const input = document.getElementById('documentoInput');
                if (input) input.focus();
            }, 100);
        }

        function cerrarModalDocumento() {
            const modal = document.getElementById('modalDocumentoUsuario');
            if (modal) modal.remove();
        }

        function validarDocumentoUsuario() {
            const documento = document.getElementById('documentoInput').value.trim();
            const errorDiv = document.getElementById('errorDocumento');

            if (!documento) {
                errorDiv.style.display = 'block';
                return;
            }

            // Verificar si hay datos cargados
            if (expedientes.length === 0) {
                errorDiv.innerHTML = '‚ùå No hay datos cargados en el sistema<br>Contacte al administrador';
                errorDiv.style.display = 'block';
                return;
            }

            // Si es admin, acceso directo
            if (documento === 'admin123' || documento === 'Extensiva2026') {
                funcionarioActual = 'Administrador';
                localStorage.setItem('dif_documento_usuario', 'Administrador');
                mostrarExpedientesAdmin();
                cerrarModalDocumento();
                return;
            }

            // Buscar funcionario por documento
            let funcionarioEncontrado = expedientes.find(e => 
                e.responsable.includes(`- ${documento}`) || 
                e.responsable.includes(documento) ||
                e.responsable.toLowerCase().includes(documento.toLowerCase())
            );

            if (!funcionarioEncontrado) {
                errorDiv.style.display = 'block';
                return;
            }

            // Extraer SOLO EL NOMBRE (sin documento)
            const nombreLimpio = extraerNombreSinDocumento(funcionarioEncontrado.responsable);
            
            // Guardar el NOMBRE limpio
            funcionarioActual = nombreLimpio;
            localStorage.setItem('dif_documento_usuario', nombreLimpio);

            mostrarExpedientesFuncionario();
            cerrarModalDocumento();
        }

        function mostrarExpedientesFuncionario() {
            if (!funcionarioActual) return;
            
            console.log("Mostrando expedientes para:", funcionarioActual);
            
            // Buscar expedientes donde el responsable contenga el NOMBRE (no documento)
            let expedientesFuncionario = expedientes.filter(exp => {
                // Extraer nombre del responsable en el expediente
                const nombreEnExpediente = extraerNombreSinDocumento(exp.responsable);
                // Comparar con el nombre del funcionario actual
                return nombreEnExpediente === funcionarioActual;
            });
            
            // Si no encuentra, intentar coincidencia parcial
            if (expedientesFuncionario.length === 0) {
                console.log("Intentando b√∫squeda parcial...");
                expedientesFuncionario = expedientes.filter(exp => {
                    const nombreEnExpediente = extraerNombreSinDocumento(exp.responsable);
                    return nombreEnExpediente.toLowerCase().includes(funcionarioActual.toLowerCase());
                });
            }
            
            if (expedientesFuncionario.length === 0) {
                mostrarPantallaBienvenida(`No se encontraron expedientes para: ${funcionarioActual}`);
                return;
            }
            
            // Mostrar nombre limpio del funcionario
            document.getElementById('userNameDisplay').style.display = 'block';
            document.getElementById('userNameDisplay').textContent = `üë§ ${funcionarioActual}`;
            
            filteredExpedientes = expedientesFuncionario;
            actualizarTabla();
            actualizarEstadisticas();
            
            // Mostrar siempre el bot√≥n de admin
            document.querySelector('.config-button').style.display = 'flex';
        }

        function mostrarExpedientesAdmin() {
            // Admin ve todos los expedientes
            filteredExpedientes = [...expedientes];
            actualizarTabla();
            actualizarEstadisticas();
            
            document.getElementById('userNameDisplay').style.display = 'block';
            document.getElementById('userNameDisplay').textContent = 'üëë Administrador';
        }

        function cerrarSesionFuncionario() {
            funcionarioActual = null;
            localStorage.removeItem('dif_documento_usuario');
            filteredExpedientes = [];
            actualizarTabla();
            actualizarEstadisticas();
            
            document.getElementById('userNameDisplay').style.display = 'none';
            
            pedirDocumentoUsuario();
        }

        function mostrarPantallaBienvenida(mensajePersonalizado = null) {
            const tbody = document.getElementById('table-body');
            if (!tbody) return;
            
            const mensaje = mensajePersonalizado || `
                <h3 style="color: #0078d4; margin-bottom: 15px;">Sistema de Consulta de Expedientes DIF</h3>
                <p style="color: #666; margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto;">
                    Sistema de seguimiento de expedientes
                </p>
            `;
            
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 50px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üèõÔ∏è</div>
                        ${mensaje}
                        
                        <div style="margin-top: 30px;">
                            <button class="btn btn-primary" onclick="cerrarSesionFuncionario()" style="padding: 12px 30px; font-size: 16px;">
                                üîÑ Cambiar de usuario
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        // ==============================================
        // SISTEMA DE ADMINISTRADOR
        // ==============================================
        function mostrarLoginAdmin() {
            document.getElementById('adminLoginModal').style.display = 'flex';
        }

        function cerrarLoginAdmin() {
            document.getElementById('adminLoginModal').style.display = 'none';
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = event.target;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }

        function validarAccesoAdmin() {
            const passwordInput = document.getElementById('adminPassword');
            const errorDiv = document.getElementById('adminPasswordError');
            const password = passwordInput.value;
            
            if (password === adminConfig.password) {
                adminConfig.sesionActiva = true;
                adminConfig.inicioSesion = new Date();
                
                localStorage.setItem('dif_sesion_admin', JSON.stringify({
                    inicio: adminConfig.inicioSesion,
                    activa: true
                }));
                
                cerrarLoginAdmin();
                mostrarModalConfiguracion();
                
                setTimeout(() => {
                    cerrarSesionAdmin();
                }, adminConfig.tiempoSesion * 60 * 1000);
                
            } else {
                errorDiv.style.display = 'block';
                passwordInput.style.borderColor = '#dc3545';
                passwordInput.value = '';
                passwordInput.focus();
                
                passwordInput.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    passwordInput.style.animation = '';
                }, 500);
            }
        }

        function verificarSesionAdminActiva() {
            const sesionGuardada = localStorage.getItem('dif_sesion_admin');
            
            if (sesionGuardada) {
                try {
                    const sesion = JSON.parse(sesionGuardada);
                    const inicio = new Date(sesion.inicio);
                    const ahora = new Date();
                    const diferenciaMin = (ahora - inicio) / (1000 * 60);
                    
                    if (sesion.activa && diferenciaMin < adminConfig.tiempoSesion) {
                        adminConfig.sesionActiva = true;
                        adminConfig.inicioSesion = inicio;
                        
                        setTimeout(() => {
                            cerrarSesionAdmin();
                        }, (adminConfig.tiempoSesion - diferenciaMin) * 60 * 1000);
                    } else {
                        localStorage.removeItem('dif_sesion_admin');
                        adminConfig.sesionActiva = false;
                    }
                } catch (e) {
                    adminConfig.sesionActiva = false;
                }
            }
        }

        function cerrarSesionAdmin() {
            adminConfig.sesionActiva = false;
            localStorage.removeItem('dif_sesion_admin');
            
            if (document.getElementById('configModal').style.display === 'flex') {
                cerrarModalConfiguracion();
            }
            
            mostrarNotificacion('Sesi√≥n cerrada', 'warning');
        }

        function mostrarModalConfiguracion() {
            if (!adminConfig.sesionActiva) {
                mostrarLoginAdmin();
                return;
            }
            
            document.getElementById('configModal').style.display = 'flex';
            cargarListaUsuarios();
            cargarHistorialSubidas();
            actualizarDisplayFechaReferencia();
            cambiarTabAdmin('expedientes');
        }

        function cerrarModalConfiguracion() {
            document.getElementById('configModal').style.display = 'none';
        }

        function cambiarTabAdmin(tabId) {
            document.querySelectorAll('#configModal .tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            document.querySelectorAll('#configModal .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(`tab-${tabId}`).style.display = 'block';
            
            document.querySelector(`#configModal .tab-btn[onclick*="${tabId}"]`).classList.add('active');
            
            if (tabId === 'usuarios') {
                cargarListaUsuarios();
            } else if (tabId === 'historial') {
                cargarHistorialSubidas();
            } else if (tabId === 'backup') {
                actualizarInfoBackup();
            }
        }

        // ==============================================
        // SISTEMA DE NOTIFICACIONES COMPLETO
        // ==============================================
        function mostrarModalNotificaciones() {
            if (!adminConfig.sesionActiva) {
                mostrarLoginAdmin();
                return;
            }
            
            document.getElementById('notificacionesModal').style.display = 'flex';
            mostrarPanelNotificaciones();
        }

        function cerrarModalNotificaciones() {
            document.getElementById('notificacionesModal').style.display = 'none';
        }

        function mostrarPanelNotificaciones() {
            const contenido = document.getElementById('notificacionesContent');
            
            contenido.innerHTML = `
                <div class="notificaciones-panel">
                    <div class="tabs-notificaciones">
                        <button class="tab-btn active" onclick="cambiarTabNotificacion('enviar')">
                            üì§ Enviar
                        </button>
                        <button class="tab-btn" onclick="cambiarTabNotificacion('historial')">
                            üìã Historial
                        </button>
                        <button class="tab-btn" onclick="cambiarTabNotificacion('automatica')">
                            ü§ñ Autom√°tica
                        </button>
                    </div>
                    
                    <div id="tab-notif-enviar" class="tab-content active">
                        ${generarContenidoEnvio()}
                    </div>
                    
                    <div id="tab-notif-historial" class="tab-content">
                        <div class="form-group">
                            <h4>üìã Historial de Notificaciones</h4>
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                <button class="btn btn-small" onclick="actualizarHistorial()">
                                    üîÑ Actualizar
                                </button>
                                <button class="btn btn-small btn-danger" onclick="limpiarHistorial()">
                                    üóëÔ∏è Limpiar
                                </button>
                            </div>
                            
                            <div id="listaHistorial" style="margin-top: 20px; max-height: 400px; overflow-y: auto;">
                                ${generarListaHistorial()}
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-notif-automatica" class="tab-content">
                        <div class="form-group">
                            <h4>ü§ñ Notificaci√≥n Autom√°tica</h4>
                            <p style="color: #666; margin-bottom: 20px;">
                                Env√≠e notificaciones autom√°ticas a usuarios con expedientes en alerta
                            </p>
                            
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                                <h5>üìä Resumen de alertas:</h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                    <div>Usuarios con alertas: <strong id="usuariosConAlertas">0</strong></div>
                                    <div>Expedientes vencidos: <strong>${expedientes.filter(e => e.estado === 'rojo').length}</strong></div>
                                    <div>Expedientes en naranja: <strong>${expedientes.filter(e => e.estado === 'naranja').length}</strong></div>
                                    <div>Expedientes en amarillo: <strong>${expedientes.filter(e => e.estado === 'amarillo').length}</strong></div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 30px;">
                                <button class="btn btn-success" onclick="iniciarNotificacionAutomatica()" style="width: 100%; padding: 15px; font-size: 16px;">
                                    ü§ñ Enviar Notificaciones Autom√°ticas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Actualizar contador de usuarios con alertas
            const usuariosConAlertas = usuariosDisponibles.filter(usuario => {
                const nombreUsuario = extraerNombreSinDocumento(usuario.nombre);
                const expedientesUsuario = expedientes.filter(e => 
                    extraerNombreSinDocumento(e.responsable) === nombreUsuario
                );
                return expedientesUsuario.some(e => e.estado === 'amarillo' || e.estado === 'naranja' || e.estado === 'rojo');
            }).length;
            
            document.getElementById('usuariosConAlertas').textContent = usuariosConAlertas;
            
            actualizarContadorSeleccionados();
        }

        function generarContenidoEnvio() {
            return `
                <div style="margin-bottom: 20px;">
                    <h3>üìß Enviar Notificaciones</h3>
                    <p style="color: #666;">Seleccione destinatarios y escriba el mensaje</p>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: #666;">
                        <span id="contadorSeleccionados">0</span> usuarios seleccionados
                    </div>
                </div>
                
                <div class="form-group">
                    <label>üìù Asunto:</label>
                    <input type="text" id="asuntoNotificacion" 
                           value="üìã Seguimiento de Expedientes DIF - Actualizaci√≥n"
                           placeholder="Asunto del correo...">
                </div>
                
                <div class="form-group">
                    <label>üí¨ Mensaje:</label>
                    <textarea id="mensajeNotificacion" rows="6" placeholder="Escriba su mensaje aqu√≠...">
Estimado/a colega,

Le informamos sobre el estado actual de los expedientes bajo su responsabilidad en el Sistema de Seguimiento DIF.

A continuaci√≥n se presenta un resumen de los expedientes que requieren atenci√≥n:

[RESUMEN_AUTOMATICO]

Por favor, revise los expedientes que se encuentran en estado de alerta o vencidos para tomar las acciones correspondientes.

Puede acceder al sistema para ver detalles completos en: [URL_SISTEMA]

Atentamente,
Divisi√≥n de Fiscalizaci√≥n y Liquidaci√≥n Tributaria Extensiva
                    </textarea>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        <strong>Variables:</strong> [RESUMEN_AUTOMATICO] [URL_SISTEMA] [NOMBRE_USUARIO]
                    </div>
                </div>
                
                <div class="form-group">
                    <label>üë• Destinatarios:</label>
                    <div style="margin-top: 10px; margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <input type="checkbox" id="seleccionarTodos" onchange="seleccionarTodosUsuarios(this.checked)">
                            <span style="font-weight: bold;">‚úÖ Seleccionar todos</span>
                        </label>
                    </div>
                    
                    <div class="usuarios-notificacion-container" id="listaUsuariosNotificacion">
                        ${generarListaUsuariosNotificacion()}
                    </div>
                </div>
                
                <div class="form-group">
                    <label>üìä Filtros:</label>
                    <div style="display: flex; gap: 15px; margin-top: 10px;">
                        <button class="btn btn-small" onclick="seleccionarSoloVencidos()">
                            üî¥ Solo vencidos
                        </button>
                        <button class="btn btn-small" onclick="seleccionarSoloAlertas()">
                            üü† Solo alertas
                        </button>
                        <button class="btn btn-small" onclick="limpiarSeleccion()">
                            üóëÔ∏è Limpiar
                        </button>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h4>üìã Resumen</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>Total usuarios: <strong>${usuariosDisponibles.length}</strong></div>
                        <div>Seleccionados: <strong id="resumenSeleccionados">0</strong></div>
                        <div>Con correo: <strong id="resumenConCorreo">0</strong></div>
                        <div>Vencidos: <strong>${expedientes.filter(e => e.estado === 'rojo').length}</strong></div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-success" onclick="enviarNotificaciones()">
                        üì§ Enviar Notificaciones
                    </button>
                    <button class="btn" onclick="cerrarModalNotificaciones()">
                        Cancelar
                    </button>
                </div>
            `;
        }

        function generarListaUsuariosNotificacion() {
            if (usuariosDisponibles.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>No hay usuarios registrados.</p>
                        <p>Cargue un archivo de expedientes primero.</p>
                    </div>
                `;
            }
            
            let html = '';
            usuariosDisponibles.forEach((usuario) => {
                const nombreUsuario = extraerNombreSinDocumento(usuario.nombre);
                const expedientesUsuario = expedientes.filter(e => 
                    extraerNombreSinDocumento(e.responsable) === nombreUsuario
                );
                const vencidos = expedientesUsuario.filter(e => e.estado === 'rojo').length;
                const alertas = expedientesUsuario.filter(e => e.estado === 'naranja' || e.estado === 'amarillo').length;
                
                html += `
                    <div class="usuario-notificacion-item">
                        <div class="usuario-notificacion-info">
                            <input type="checkbox" id="usuario-${usuario.id}" 
                                   class="usuario-checkbox" data-id="${usuario.id}"
                                   data-nombre="${usuario.nombre}" data-email="${usuario.email || ''}"
                                   onchange="actualizarContadorSeleccionados()">
                            <div class="usuario-avatar">
                                ${nombreUsuario.charAt(0).toUpperCase()}
                            </div>
                            <div class="usuario-detalles">
                                <h4>${nombreUsuario}</h4>
                                <p>üìß ${usuario.email || 'Sin correo'}</p>
                                <div style="display: flex; gap: 10px; font-size: 12px; margin-top: 5px;">
                                    ${expedientesUsuario.length > 0 ? `<span>üìã ${expedientesUsuario.length}</span>` : ''}
                                    ${vencidos > 0 ? `<span style="color: #dc3545;">üî¥ ${vencidos}</span>` : ''}
                                    ${alertas > 0 ? `<span style="color: #ff9800;">üü† ${alertas}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }

        function cambiarTabNotificacion(tabId) {
            document.querySelectorAll('#notificacionesContent .tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            document.querySelectorAll('#notificacionesContent .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(`tab-notif-${tabId}`).style.display = 'block';
            
            document.querySelector(`#notificacionesContent .tab-btn[onclick*="${tabId}"]`).classList.add('active');
            
            if (tabId === 'historial') {
                actualizarHistorial();
            }
        }

        function seleccionarTodosUsuarios(seleccionar) {
            const checkboxes = document.querySelectorAll('.usuario-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = seleccionar;
            });
            actualizarContadorSeleccionados();
        }

        function seleccionarSoloVencidos() {
            seleccionarTodosUsuarios(false);
            
            usuariosDisponibles.forEach(usuario => {
                const nombreUsuario = extraerNombreSinDocumento(usuario.nombre);
                const expedientesUsuario = expedientes.filter(e => 
                    extraerNombreSinDocumento(e.responsable) === nombreUsuario
                );
                const tieneVencidos = expedientesUsuario.some(e => e.estado === 'rojo');
                
                if (tieneVencidos) {
                    const checkbox = document.getElementById(`usuario-${usuario.id}`);
                    if (checkbox) checkbox.checked = true;
                }
            });
            
            actualizarContadorSeleccionados();
        }

        function seleccionarSoloAlertas() {
            seleccionarTodosUsuarios(false);
            
            usuariosDisponibles.forEach(usuario => {
                const nombreUsuario = extraerNombreSinDocumento(usuario.nombre);
                const expedientesUsuario = expedientes.filter(e => 
                    extraerNombreSinDocumento(e.responsable) === nombreUsuario
                );
                const tieneAlertas = expedientesUsuario.some(e => 
                    e.estado === 'naranja' || e.estado === 'amarillo' || e.estado === 'rojo'
                );
                
                if (tieneAlertas) {
                    const checkbox = document.getElementById(`usuario-${usuario.id}`);
                    if (checkbox) checkbox.checked = true;
                }
            });
            
            actualizarContadorSeleccionados();
        }

        function limpiarSeleccion() {
            seleccionarTodosUsuarios(false);
        }

        function actualizarContadorSeleccionados() {
            const checkboxes = document.querySelectorAll('.usuario-checkbox:checked');
            const contador = document.getElementById('contadorSeleccionados');
            const resumenSeleccionados = document.getElementById('resumenSeleccionados');
            const resumenConCorreo = document.getElementById('resumenConCorreo');
            
            if (contador) contador.textContent = checkboxes.length;
            if (resumenSeleccionados) resumenSeleccionados.textContent = checkboxes.length;
            
            let conCorreo = 0;
            checkboxes.forEach(checkbox => {
                const email = checkbox.dataset.email;
                if (email && email.includes('@')) conCorreo++;
            });
            
            if (resumenConCorreo) resumenConCorreo.textContent = conCorreo;
        }

        // ==============================================
        // HISTORIAL DE NOTIFICACIONES
        // ==============================================
        function generarListaHistorial() {
            const historial = obtenerHistorialNotificaciones();
            
            if (historial.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>No hay historial de notificaciones.</p>
                        <p>Las notificaciones enviadas aparecer√°n aqu√≠.</p>
                    </div>
                `;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            historial.forEach((notif) => {
                const fecha = new Date(notif.fecha);
                const fechaFormateada = fecha.toLocaleDateString() + ' ' + fecha.toLocaleTimeString().substring(0, 5);
                
                let estadoIcono = '‚ÑπÔ∏è';
                if (notif.enviadosExitosos === notif.destinatarios) estadoIcono = '‚úÖ';
                else if (notif.enviadosExitosos > 0) estadoIcono = '‚ö†Ô∏è';
                else if (notif.enviadosExitosos === 0) estadoIcono = '‚ùå';
                
                html += `
                    <div class="historial-item">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    ${estadoIcono}
                                    <strong style="font-size: 16px;">${notif.asunto || 'Notificaci√≥n'}</strong>
                                </div>
                                <div style="color: #666; font-size: 14px;">
                                    <div>üìÖ ${fechaFormateada}</div>
                                    <div>üë• ${notif.destinatarios || 0} destinatarios</div>
                                    <div>üì® ${notif.enviadosExitosos || 0} enviados ‚Ä¢ ${notif.errores || 0} errores</div>
                                    ${notif.tipo === 'automatica' ? '<div>ü§ñ Autom√°tica</div>' : ''}
                                </div>
                            </div>
                            <button class="btn-icon" onclick="verDetalleHistorial(${notif.id})" title="Ver detalles" style="margin-left: 10px;">
                                üëÅÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function actualizarHistorial() {
            const lista = document.getElementById('listaHistorial');
            if (lista) {
                lista.innerHTML = generarListaHistorial();
            }
        }

        function limpiarHistorial() {
            if (confirm('¬øEliminar todo el historial?')) {
                localStorage.removeItem('dif_historial_notificaciones');
                actualizarHistorial();
                mostrarNotificacion('Historial eliminado', 'success');
            }
        }

        function verDetalleHistorial(id) {
            const historial = obtenerHistorialNotificaciones();
            const notificacion = historial.find(n => n.id === id);
            
            if (!notificacion) return;
            
            const fecha = new Date(notificacion.fecha);
            const detalles = `
                üìã DETALLE DE NOTIFICACI√ìN
                --------------------------
                
                üìù Asunto: ${notificacion.asunto || 'Sin asunto'}
                üìÖ Fecha: ${fecha.toLocaleDateString()} ${fecha.toLocaleTimeString()}
                üë• Destinatarios: ${notificacion.destinatarios || 0}
                üì® Enviados exitosos: ${notificacion.enviadosExitosos || 0}
                ‚ùå Errores: ${notificacion.errores || 0}
                üéØ Tipo: ${notificacion.tipo === 'automatica' ? 'Autom√°tica' : 'Manual'}
            `;
            
            alert(detalles);
        }

        function obtenerHistorialNotificaciones() {
            const historialGuardado = localStorage.getItem('dif_historial_notificaciones');
            return historialGuardado ? JSON.parse(historialGuardado) : [];
        }

        function guardarEnHistorialNotificaciones(notificacion) {
            let historial = obtenerHistorialNotificaciones();
            historial.unshift(notificacion);
            historial = historial.slice(0, 100);
            localStorage.setItem('dif_historial_notificaciones', JSON.stringify(historial));
        }

        // ==============================================
        // ENV√çO DE NOTIFICACIONES
        // ==============================================
        async function enviarNotificaciones() {
            const checkboxes = Array.from(document.querySelectorAll('.usuario-checkbox:checked'));
            if (checkboxes.length === 0) {
                mostrarNotificacion('Seleccione destinatarios', 'warning');
                return;
            }
            
            const usuariosConCorreo = checkboxes.filter(checkbox => {
                const email = checkbox.dataset.email;
                return email && email.includes('@');
            });
            
            if (usuariosConCorreo.length === 0) {
                mostrarNotificacion('No hay correos v√°lidos', 'warning');
                return;
            }
            
            const asunto = document.getElementById('asuntoNotificacion').value;
            const mensajeBase = document.getElementById('mensajeNotificacion').value;
            
            if (!asunto || !mensajeBase) {
                mostrarNotificacion('Complete el asunto y mensaje', 'warning');
                return;
            }
            
            const confirmacion = confirm(`¬øEnviar a ${usuariosConCorreo.length} destinatarios?`);
            if (!confirmacion) return;
            
            mostrarProgresoEnvio(usuariosConCorreo.length);
            
            let enviadosExitosos = 0;
            let errores = [];
            
            for (let i = 0; i < usuariosConCorreo.length; i++) {
                const checkbox = usuariosConCorreo[i];
                const usuario = {
                    nombre: checkbox.dataset.nombre,
                    email: checkbox.dataset.email
                };
                
                const nombreLimpio = extraerNombreSinDocumento(usuario.nombre);
                const mensajePersonalizado = personalizarMensaje(mensajeBase, nombreLimpio);
                
                try {
                    const resultado = await enviarCorreo(usuario.email, asunto, mensajePersonalizado);
                    
                    if (resultado.exito) {
                        enviadosExitosos++;
                        actualizarProgresoEnvio(i + 1, usuariosConCorreo.length, nombreLimpio, true);
                    } else {
                        errores.push(`${nombreLimpio}: ${resultado.error}`);
                        actualizarProgresoEnvio(i + 1, usuariosConCorreo.length, nombreLimpio, false);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    errores.push(`${nombreLimpio}: Error`);
                }
            }
            
            const notificacion = {
                id: Date.now(),
                fecha: new Date().toISOString(),
                asunto: asunto,
                destinatarios: usuariosConCorreo.length,
                enviadosExitosos: enviadosExitosos,
                errores: errores.length,
                tipo: 'manual'
            };
            
            guardarEnHistorialNotificaciones(notificacion);
            actualizarEstadisticasNotificaciones();
            
            mostrarResumenEnvio(enviadosExitosos, usuariosConCorreo.length, errores);
        }

        async function iniciarNotificacionAutomatica() {
            const usuariosConAlertas = usuariosDisponibles.filter(usuario => {
                const nombreUsuario = extraerNombreSinDocumento(usuario.nombre);
                const expedientesUsuario = expedientes.filter(e => 
                    extraerNombreSinDocumento(e.responsable) === nombreUsuario
                );
                return expedientesUsuario.some(e => 
                    e.estado === 'amarillo' || e.estado === 'naranja' || e.estado === 'rojo'
                );
            });
            
            if (usuariosConAlertas.length === 0) {
                mostrarNotificacion("No hay usuarios con alertas", "info");
                return;
            }
            
            const asunto = `üìã Sistema DIF - Alertas de Expedientes`;
            const mensajeBase = `Estimado/a responsable,

Le informamos sobre el estado actual de los expedientes bajo su responsabilidad.

A continuaci√≥n se presenta un resumen de los expedientes que requieren atenci√≥n:

[RESUMEN_AUTOMATICO]

Por favor, revise los expedientes en estado de alerta o vencidos.

Atentamente,
Divisi√≥n de Fiscalizaci√≥n`;

            const confirmar = confirm(
                `¬øEnviar notificaciones autom√°ticas?\n\n` +
                `‚Ä¢ Destinatarios: ${usuariosConAlertas.length} usuarios\n` +
                `‚Ä¢ Se enviar√°n correos personalizados`
            );
            
            if (!confirmar) return;
            
            mostrarProgresoEnvio(usuariosConAlertas.length);
            
            let enviadosExitosos = 0;
            let errores = [];
            
            for (let i = 0; i < usuariosConAlertas.length; i++) {
                const usuario = usuariosConAlertas[i];
                const nombreLimpio = extraerNombreSinDocumento(usuario.nombre);
                
                const mensajePersonalizado = personalizarMensaje(mensajeBase, nombreLimpio);
                
                try {
                    const resultado = await enviarCorreo(
                        usuario.email || `${nombreLimpio.toLowerCase().replace(/\s+/g, '.')}@dif.gob.mx`,
                        asunto,
                        mensajePersonalizado
                    );
                    
                    if (resultado.exito) {
                        enviadosExitosos++;
                        actualizarProgresoEnvio(i + 1, usuariosConAlertas.length, nombreLimpio, true);
                    } else {
                        errores.push(`${nombreLimpio}: ${resultado.error}`);
                        actualizarProgresoEnvio(i + 1, usuariosConAlertas.length, nombreLimpio, false);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    errores.push(`${nombreLimpio}: Error`);
                }
            }
            
            const notificacion = {
                id: Date.now(),
                fecha: new Date().toISOString(),
                asunto: "Notificaci√≥n Autom√°tica - Alertas",
                destinatarios: usuariosConAlertas.length,
                enviadosExitosos: enviadosExitosos,
                errores: errores.length,
                tipo: 'automatica'
            };
            
            guardarEnHistorialNotificaciones(notificacion);
            actualizarEstadisticasNotificaciones();
            
            mostrarResumenEnvio(enviadosExitosos, usuariosConAlertas.length, errores);
        }

        function personalizarMensaje(mensajeBase, nombreUsuario) {
            let mensaje = mensajeBase;
            
            mensaje = mensaje.replace(/\[NOMBRE_USUARIO\]/g, nombreUsuario);
            mensaje = mensaje.replace(/\[URL_SISTEMA\]/g, window.location.href);
            
            const expedientesUsuario = expedientes.filter(e => 
                extraerNombreSinDocumento(e.responsable) === nombreUsuario
            );
            const vencidos = expedientesUsuario.filter(e => e.estado === 'rojo');
            const alertas = expedientesUsuario.filter(e => e.estado === 'naranja' || e.estado === 'amarillo');
            
            let resumen = `\n\nüìä RESUMEN DE SUS EXPEDIENTES:\n`;
            resumen += `‚Ä¢ Total expedientes: ${expedientesUsuario.length}\n`;
            if (vencidos.length > 0) resumen += `‚Ä¢ üî¥ Vencidos: ${vencidos.length}\n`;
            if (alertas.length > 0) resumen += `‚Ä¢ üü† En alerta: ${alertas.length}\n`;
            if (expedientesUsuario.length === 0) resumen += `‚Ä¢ No tiene expedientes asignados\n`;
            
            mensaje = mensaje.replace(/\[RESUMEN_AUTOMATICO\]/g, resumen);
            
            return mensaje;
        }

        async function enviarCorreo(destinatario, asunto, mensaje) {
            const templateParams = {
                nombre_usuario: extraerNombreSinDocumento(destinatario),
                mensaje_personalizado: mensaje,
                email: destinatario,
                asunto: asunto
            };
            
            try {
                const response = await emailjs.send(
                    "service_5wbrx07",
                    "template_8rxwtet",
                    templateParams
                );
                
                return { 
                    exito: true, 
                    mensaje: `Enviado a ${destinatario}`,
                    detalles: response
                };
                
            } catch (error) {
                let mensajeError = "Error desconocido";
                if (error.status === 404) {
                    mensajeError = "Service ID o Template ID no encontrado";
                } else if (error.status === 400) {
                    mensajeError = "Par√°metros incorrectos";
                } else if (error.text) {
                    mensajeError = error.text;
                }
                
                return { 
                    exito: false, 
                    error: mensajeError
                };
            }
        }

        function mostrarProgresoEnvio(total) {
            const contenido = document.getElementById('notificacionesContent');
            contenido.innerHTML = `
                <div class="notificaciones-panel">
                    <div style="text-align: center; padding: 30px;">
                        <div class="login-icon">üì§</div>
                        <h3>Enviando Notificaciones</h3>
                        <p style="color: #666; margin-bottom: 30px;">
                            Enviando correos a ${total} destinatario(s)...
                        </p>
                        
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Progreso:</span>
                                <span id="progresoActual">0</span>/<span id="progresoTotal">${total}</span>
                            </div>
                            <div style="width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden;">
                                <div id="barraProgreso" style="width: 0%; height: 100%; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); transition: width 0.3s;"></div>
                            </div>
                        </div>
                        
                        <div id="detalleProgreso" style="margin-top: 20px; max-height: 200px; overflow-y: auto; text-align: left;">
                        </div>
                    </div>
                </div>
            `;
        }

        function actualizarProgresoEnvio(actual, total, usuario, exito) {
            const barra = document.getElementById('barraProgreso');
            const progresoActual = document.getElementById('progresoActual');
            const detalle = document.getElementById('detalleProgreso');
            
            if (barra) barra.style.width = `${(actual / total) * 100}%`;
            if (progresoActual) progresoActual.textContent = actual;
            
            if (detalle) {
                const item = document.createElement('div');
                item.style.cssText = `
                    padding: 8px 12px;
                    margin-bottom: 5px;
                    background: ${exito ? '#d4edda' : '#f8d7da'};
                    border-radius: 5px;
                    border-left: 4px solid ${exito ? '#28a745' : '#dc3545'};
                    font-size: 14px;
                `;
                item.innerHTML = `
                    ${exito ? '‚úÖ' : '‚ùå'} ${usuario} 
                    <span style="float: right; color: #666;">${exito ? 'Enviado' : 'Error'}</span>
                `;
                detalle.appendChild(item);
                detalle.scrollTop = detalle.scrollHeight;
            }
        }

        function mostrarResumenEnvio(exitosos, total, errores) {
            let html = `
                <div class="notificaciones-panel">
                    <div style="text-align: center; padding: 20px;">
                        <div class="login-icon">${exitosos === total ? 'üéâ' : exitosos > 0 ? '‚ö†Ô∏è' : '‚ùå'}</div>
                        <h3>${exitosos === total ? '¬°Env√≠o Completado!' : exitosos > 0 ? 'Env√≠o Parcial' : 'Env√≠o Fallido'}</h3>
                        
                        <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div style="background: white; padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 32px; font-weight: bold; color: #28a745;">${exitosos}</div>
                                    <div style="color: #666;">Enviados</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 32px; font-weight: bold; color: #dc3545;">${total - exitosos}</div>
                                    <div style="color: #666;">Errores</div>
                                </div>
                            </div>
                            
                            <div style="text-align: left;">
                                <strong>Resumen:</strong>
                                <ul style="margin-top: 10px;">
                                    <li>Destinatarios: ${total}</li>
                                    <li>Enviados: ${exitosos}</li>
                                    <li>Errores: ${total - exitosos}</li>
                                    <li>Tasa: ${Math.round((exitosos / total) * 100)}%</li>
                                </ul>
                            </div>
                        </div>
            `;
            
            if (errores.length > 0) {
                html += `
                    <div style="margin-top: 20px; text-align: left;">
                        <strong>Errores:</strong>
                        <div style="margin-top: 10px; max-height: 150px; overflow-y: auto; background: #f8d7da; padding: 10px; border-radius: 5px;">
                            ${errores.map(error => `<div style="margin-bottom: 5px;">‚ùå ${error}</div>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            html += `
                        <div style="margin-top: 30px;">
                            <button class="btn btn-primary" onclick="mostrarPanelNotificaciones()">
                                ‚Ü©Ô∏è Volver
                            </button>
                            <button class="btn" onclick="cerrarModalNotificaciones()" style="margin-left: 10px;">
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('notificacionesContent').innerHTML = html;
        }

        function actualizarEstadisticasNotificaciones() {
            document.getElementById('totalUsuariosNotificacion').textContent = usuariosDisponibles.length;
            document.getElementById('expedientesVencidos').textContent = expedientes.filter(e => e.estado === 'rojo').length;
            
            const historial = obtenerHistorialNotificaciones();
            document.getElementById('totalNotificacionesEnviadas').textContent = historial.length;
            
            if (historial.length > 0) {
                const ultima = historial[0];
                const fecha = new Date(ultima.fecha);
                document.getElementById('ultimaNotificacion').textContent = 
                    fecha.toLocaleDateString().substring(0, 10);
            }
        }

        // ==============================================
        // SISTEMA DE HISTORIAL DE SUBIDAS
        // ==============================================
        function agregarAlHistorialSubidas(nombreArchivo, cantidadExpedientes) {
            const subida = {
                id: Date.now(),
                fecha: new Date().toISOString(),
                nombreArchivo: nombreArchivo,
                cantidadExpedientes: cantidadExpedientes,
                usuario: 'Administrador'
            };
            
            historialSubidas.unshift(subida);
            historialSubidas = historialSubidas.slice(0, 50);
            
            guardarConfiguracion();
            cargarHistorialSubidas();
        }

        function cargarHistorialSubidas() {
            const contenedor = document.getElementById('historialSubidas');
            if (!contenedor) return;
            
            if (historialSubidas.length === 0) {
                contenedor.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>No hay historial de subidas.</p>
                        <p>Las subidas de archivos aparecer√°n aqu√≠.</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            historialSubidas.forEach((subida) => {
                const fecha = new Date(subida.fecha);
                const fechaFormateada = fecha.toLocaleDateString() + ' ' + fecha.toLocaleTimeString().substring(0, 5);
                
                html += `
                    <div class="historial-subida-item">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                üìÅ
                                <strong style="font-size: 14px;">${subida.nombreArchivo}</strong>
                            </div>
                            <div style="color: #666; font-size: 12px;">
                                <div>üìÖ ${fechaFormateada} ‚Ä¢ üë§ ${subida.usuario}</div>
                                <div>üìä ${subida.cantidadExpedientes} expedientes</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            contenedor.innerHTML = html;
        }

        function exportarHistorialExcel() {
            if (historialSubidas.length === 0) {
                mostrarNotificacion('No hay historial para exportar', 'warning');
                return;
            }
            
            try {
                const ws = XLSX.utils.json_to_sheet(historialSubidas.map(subida => ({
                    'Fecha': new Date(subida.fecha).toLocaleString(),
                    'Archivo': subida.nombreArchivo,
                    'Expedientes': subida.cantidadExpedientes,
                    'Usuario': subida.usuario
                })));
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Historial");
                
                const fecha = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `Historial_Subidas_${fecha}.xlsx`);
                
                mostrarNotificacion('Historial exportado a Excel', 'success');
                
            } catch (error) {
                mostrarNotificacion(`Error exportando: ${error.message}`, 'error');
            }
        }

        function limpiarHistorialSubidas() {
            if (confirm('¬øEliminar todo el historial de subidas?')) {
                historialSubidas = [];
                guardarConfiguracion();
                cargarHistorialSubidas();
                mostrarNotificacion('Historial eliminado', 'success');
            }
        }

        // ==============================================
        // SISTEMA DE COPIA DE SEGURIDAD
        // ==============================================
        function descargarBackup() {
            const backupData = {
                expedientes: expedientes,
                usuariosDisponibles: usuariosDisponibles,
                historialSubidas: historialSubidas,
                fechaReferencia: fechaReferencia.toISOString(),
                fechaBackup: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `backup_expedientes_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            mostrarNotificacion('Backup descargado exitosamente', 'success');
        }

        function handleBackupUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.json')) {
                mostrarNotificacion('Solo se aceptan archivos JSON', 'error');
                return;
            }
            
            const fileInfoDiv = document.getElementById('backupFileInfo');
            const fileNameSpan = document.getElementById('backupFileName');
            const fileSizeSpan = document.getElementById('backupFileSize');
            const restaurarBtn = document.getElementById('restaurarBtn');
            
            if (fileInfoDiv) fileInfoDiv.style.display = 'flex';
            if (fileNameSpan) fileNameSpan.textContent = file.name;
            if (fileSizeSpan) fileSizeSpan.textContent = `Tama√±o: ${(file.size / 1024).toFixed(1)} KB`;
            if (restaurarBtn) {
                restaurarBtn.disabled = false;
                restaurarBtn.textContent = 'üîÑ Restaurar';
            }
            
            archivoBackup = file;
            
            mostrarNotificacion(`Backup cargado`, 'success');
        }

        function eliminarBackupFile() {
            archivoBackup = null;
            const fileInput = document.getElementById('backupFileInput');
            const fileInfoDiv = document.getElementById('backupFileInfo');
            const restaurarBtn = document.getElementById('restaurarBtn');
            
            if (fileInput) fileInput.value = '';
            if (fileInfoDiv) fileInfoDiv.style.display = 'none';
            if (restaurarBtn) {
                restaurarBtn.disabled = true;
                restaurarBtn.textContent = 'üîÑ Restaurar';
            }
            
            mostrarNotificacion('Backup eliminado', 'success');
        }

        function restaurarBackup() {
            if (!archivoBackup) {
                mostrarNotificacion('No hay archivo de backup', 'warning');
                return;
            }
            
            if (!confirm('¬øRestaurar backup?\n\nEsta acci√≥n sobrescribir√° todos los datos actuales.')) {
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (!backupData.expedientes || !Array.isArray(backupData.expedientes)) {
                        throw new Error('Estructura de backup inv√°lida');
                    }
                    
                    expedientes = backupData.expedientes || [];
                    usuariosDisponibles = backupData.usuariosDisponibles || [];
                    historialSubidas = backupData.historialSubidas || [];
                    
                    if (backupData.fechaReferencia) {
                        fechaReferencia = new Date(backupData.fechaReferencia);
                    }
                    
                    filteredExpedientes = [...expedientes];
                    
                    actualizarTabla();
                    actualizarEstadisticas();
                    actualizarDisplayFechaReferencia();
                    cargarHistorialSubidas();
                    actualizarInfoBackup();
                    actualizarEstadisticasNotificaciones();
                    
                    guardarConfiguracion();
                    
                    mostrarNotificacion(`Backup restaurado: ${expedientes.length} expedientes`, 'success');
                    
                    eliminarBackupFile();
                    
                } catch (error) {
                    mostrarNotificacion(`Error restaurando backup: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = function() {
                mostrarNotificacion('Error leyendo archivo de backup', 'error');
            };
            
            reader.readAsText(archivoBackup, 'UTF-8');
        }

        function actualizarInfoBackup() {
            document.getElementById('totalExpedientesBackup').textContent = expedientes.length;
            document.getElementById('totalUsuariosBackup').textContent = usuariosDisponibles.length;
            document.getElementById('historialSubidasCount').textContent = historialSubidas.length;
            
            if (historialSubidas.length > 0) {
                const ultima = historialSubidas[0];
                const fecha = new Date(ultima.fecha);
                document.getElementById('ultimaSubida').textContent = 
                    fecha.toLocaleDateString().substring(0, 10);
            }
        }

        // ==============================================
        // FUNCIONES DE PROCESAMIENTO DE ARCHIVOS
        // ==============================================
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileName = file.name.toLowerCase();
            const esExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
            const esCSV = fileName.endsWith('.csv');
            
            if (!esExcel && !esCSV) {
                mostrarNotificacion('Suba Excel o CSV', 'error');
                return;
            }
            
            archivoCargado = file;
            
            const fileInfoDiv = document.getElementById('fileInfo');
            const fileNameSpan = document.getElementById('fileName');
            const fileSizeSpan = document.getElementById('fileSize');
            const fileTypeSpan = document.getElementById('fileType');
            const procesarBtn = document.getElementById('procesarBtn');
            
            if (fileInfoDiv) fileInfoDiv.style.display = 'flex';
            if (fileNameSpan) fileNameSpan.textContent = file.name;
            if (fileSizeSpan) fileSizeSpan.textContent = `Tama√±o: ${(file.size / 1024).toFixed(1)} KB`;
            if (fileTypeSpan) fileTypeSpan.textContent = `Tipo: ${esExcel ? 'Excel' : 'CSV'}`;
            if (procesarBtn) {
                procesarBtn.disabled = false;
                procesarBtn.textContent = 'üìã Cargar';
            }
            
            mostrarNotificacion(`Archivo cargado`, 'success');
        }

        function eliminarArchivo() {
            archivoCargado = null;
            const fileInput = document.getElementById('fileInput');
            const fileInfoDiv = document.getElementById('fileInfo');
            const processingInfo = document.getElementById('processingInfo');
            const procesarBtn = document.getElementById('procesarBtn');
            
            if (fileInput) fileInput.value = '';
            if (fileInfoDiv) fileInfoDiv.style.display = 'none';
            if (processingInfo) processingInfo.style.display = 'none';
            if (procesarBtn) {
                procesarBtn.disabled = true;
                procesarBtn.textContent = 'üìã Cargar';
            }
            
            mostrarNotificacion('Archivo eliminado', 'success');
        }

        function procesarArchivo() {
            if (!archivoCargado) {
                mostrarNotificacion('No hay archivo', 'warning');
                return;
            }
            
            const fileName = archivoCargado.name.toLowerCase();
            const esExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
            
            const processingInfo = document.getElementById('processingInfo');
            const processingText = document.getElementById('processingText');
            const procesarBtn = document.getElementById('procesarBtn');
            
            if (processingInfo) processingInfo.style.display = 'block';
            if (processingText) processingText.textContent = 'Procesando...';
            if (procesarBtn) {
                procesarBtn.disabled = true;
                procesarBtn.textContent = '‚è≥ Procesando...';
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let expedientesCargados = [];
                    
                    if (esExcel) {
                        expedientesCargados = procesarExcel(e.target.result);
                    } else {
                        expedientesCargados = procesarCSV(e.target.result);
                    }
                    
                    if (expedientesCargados.length === 0) {
                        if (processingInfo) processingInfo.style.display = 'none';
                        if (procesarBtn) {
                            procesarBtn.disabled = false;
                            procesarBtn.textContent = 'üìã Cargar';
                        }
                        mostrarNotificacion('No hay expedientes v√°lidos', 'error');
                        return;
                    }
                    
                    const usuariosDelArchivo = extraerUsuariosDeExpedientes(expedientesCargados);
                    
                    const usuariosExistentes = usuariosDisponibles.filter(u => u.origen === 'manual');
                    const nuevosUsuarios = usuariosDelArchivo.filter(nuevo => 
                        !usuariosExistentes.some(existente => existente.nombre === nuevo.nombre)
                    );
                    
                    usuariosDisponibles = [...usuariosExistentes, ...nuevosUsuarios];
                    
                    cargarListaUsuarios();
                    
                    expedientes = expedientesCargados;
                    filteredExpedientes = [...expedientes];
                    
                    agregarAlHistorialSubidas(archivoCargado.name, expedientes.length);
                    
                    actualizarTabla();
                    actualizarEstadisticas();
                    actualizarInfoBackup();
                    actualizarEstadisticasNotificaciones();
                    
                    if (processingInfo) processingInfo.style.display = 'none';
                    if (processingText) processingText.textContent = '';
                    if (procesarBtn) procesarBtn.textContent = '‚úÖ Cargado';
                    
                    mostrarNotificacion(`${expedientes.length} expedientes cargados`, 'success');
                    
                    if (funcionarioActual) {
                        if (funcionarioActual === 'Administrador') {
                            mostrarExpedientesAdmin();
                        } else {
                            mostrarExpedientesFuncionario();
                        }
                    }
                    
                } catch (error) {
                    if (processingInfo) processingInfo.style.display = 'none';
                    if (procesarBtn) {
                        procesarBtn.disabled = false;
                        procesarBtn.textContent = 'üìã Cargar';
                    }
                    mostrarNotificacion(`Error: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = function() {
                if (processingInfo) processingInfo.style.display = 'none';
                if (procesarBtn) {
                    procesarBtn.disabled = false;
                    procesarBtn.textContent = 'üìã Cargar';
                }
                mostrarNotificacion('Error leyendo archivo', 'error');
            };
            
            if (esExcel) {
                reader.readAsArrayBuffer(archivoCargado);
            } else {
                reader.readAsText(archivoCargado, 'UTF-8');
            }
        }

        // ==============================================
        // SEMAFORIZACI√ìN ACTUALIZADA (CON 3 MESES VERDE)
        // ==============================================
        function calcularSemaforizacion(fechaApertura, fechaReasignacion) {
            let fechaBase;
            if (fechaReasignacion && fechaReasignacion !== '' && fechaReasignacion !== 'null') {
                fechaBase = new Date(fechaReasignacion);
            } else if (fechaApertura && fechaApertura !== '' && fechaApertura !== 'null') {
                fechaBase = new Date(fechaApertura);
            } else {
                return { 
                    estado: 'sin_datos', 
                    tiempo: 'Sin fecha', 
                    mesesFaltantes: null,
                    mesesTranscurridos: null,
                    fechaBase: null
                };
            }
            
            if (isNaN(fechaBase.getTime())) {
                return { 
                    estado: 'error', 
                    tiempo: 'Fecha inv√°lida', 
                    mesesFaltantes: null,
                    mesesTranscurridos: null,
                    fechaBase: fechaApertura || fechaReasignacion
                };
            }
            
            const mesesTranscurridos = (fechaReferencia.getTime() - fechaBase.getTime()) / (1000 * 60 * 60 * 24 * 30.44);
            const mesesFaltantes = PERIODO_REVISION_MESES - mesesTranscurridos;
            
            let estado, tiempoTexto;
            
            if (mesesFaltantes > 2) {  // 4+ y 3 meses = VERDE
                estado = 'verde';
                if (mesesFaltantes >= 4) {
                    tiempoTexto = `Faltan ${Math.floor(mesesFaltantes)} meses`;
                } else {
                    tiempoTexto = `Faltan 3 meses`;
                }
            } else if (mesesFaltantes > 1) {  // 2 meses = AMARILLO
                estado = 'amarillo';
                tiempoTexto = `Faltan 2 meses`;
            } else if (mesesFaltantes > 0) {  // 1 mes = NARANJA
                estado = 'naranja';
                tiempoTexto = `Falta 1 mes`;
            } else {  // 0 o menos meses = ROJO
                estado = 'rojo';
                const mesesVencido = Math.abs(Math.floor(mesesFaltantes));
                tiempoTexto = `Vencida hace ${mesesVencido} mes${mesesVencido !== 1 ? 'es' : ''}`;
            }
            
            return {
                estado: estado,
                tiempo: tiempoTexto,
                mesesFaltantes: mesesFaltantes,
                mesesTranscurridos: mesesTranscurridos,
                fechaBase: fechaBase.toISOString().split('T')[0]
            };
        }

        function generarDescripcion(semaforo) {
            if (semaforo.estado === 'rojo') {
                const mesesVencido = Math.abs(Math.ceil(semaforo.mesesFaltantes));
                return `Vencida hace ${mesesVencido} ${mesesVencido === 1 ? 'mes' : 'meses'} - Atenci√≥n inmediata`;
            } else if (semaforo.estado === 'naranja') {
                return `Falta 1 mes para revisi√≥n`;
            } else if (semaforo.estado === 'amarillo') {
                return `Faltan 2 meses para revisi√≥n`;
            } else if (semaforo.estado === 'verde') {
                if (semaforo.mesesFaltantes >= 4) {
                    return `Faltan ${Math.floor(semaforo.mesesFaltantes)} meses para revisi√≥n`;
                } else {
                    return `Faltan 3 meses para revisi√≥n`;
                }
            } else if (semaforo.estado === 'sin_datos') {
                return 'Sin fecha de inicio';
            } else if (semaforo.estado === 'error') {
                return 'Fecha inv√°lida';
            }
            return 'Estado no determinado';
        }

        // ==============================================
        // FUNCIONES DE PROCESAMIENTO EXCEL/CSV
        // ==============================================
        function procesarExcel(data) {
            try {
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                
                if (jsonData.length < 2) throw new Error('Archivo vac√≠o');
                
                const headers = jsonData[0].map(h => String(h || '').trim());
                
                const encontrarIndice = (patrones) => {
                    for (const patron of patrones) {
                        const indice = headers.findIndex(h => 
                            h && h.toString().toLowerCase().includes(patron.toLowerCase())
                        );
                        if (indice >= 0) return indice;
                    }
                    return -1;
                };
                
                const colIndices = {
                    expediente: encontrarIndice(['expediente', 'numero', 'numexp', 'n√∫mero', 'id']),
                    fechaApertura: encontrarIndice(['fecha apertura', 'fecha_apertura', 'apertura']),
                    fechaReasignacion: encontrarIndice(['fecha reasignacion', 'fecha_reasignacion', 'reasignacion']),
                    responsable: encontrarIndice(['responsable', 'funcionario', 'auditor', 'encargado']),            
                };
                
                if (colIndices.responsable === -1 && headers.length > 0) {
                    colIndices.responsable = 0;
                }
                
                const result = [];
                
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row || row.length === 0) continue;
                    
                    const numeroExpediente = colIndices.expediente >= 0 ? String(row[colIndices.expediente] || '').trim() : '';
                    const fechaApertura = colIndices.fechaApertura >= 0 ? String(row[colIndices.fechaApertura] || '').trim() : '';
                    const fechaReasignacion = colIndices.fechaReasignacion >= 0 ? String(row[colIndices.fechaReasignacion] || '').trim() : '';
                    const responsable = colIndices.responsable >= 0 ? String(row[colIndices.responsable] || '').trim() : '';            
                    
                    if (numeroExpediente || responsable) {
                        const semaforo = calcularSemaforizacion(fechaApertura, fechaReasignacion);
                        const descripcion = generarDescripcion(semaforo);
                        
                        result.push({
                            id: result.length + 1,
                            nombre: numeroExpediente || `Expediente ${result.length + 1}`,
                            descripcion: descripcion,
                            estado: semaforo.estado,
                            tiempo: semaforo.tiempo,
                            responsable: responsable || 'No asignado',
                            fechaRevision: semaforo.fechaBase,
                            fechaApertura: fechaApertura,
                            fechaReasignacion: fechaReasignacion,
                            mesesFaltantes: semaforo.mesesFaltantes,
                            mesesTranscurridos: semaforo.mesesTranscurridos
                        });
                    }
                }
                
                return result;
                
            } catch (error) {
                throw new Error('Error Excel: ' + error.message);
            }
        }

        function procesarCSV(csvText) {
            try {
                const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
                
                if (lines.length < 2) throw new Error('Archivo vac√≠o');
                
                const headers = parseCSVLine(lines[0]);
                if (headers.length === 0) throw new Error('Sin encabezados');
                
                const encontrarIndice = (patrones) => {
                    for (const patron of patrones) {
                        const indice = headers.findIndex(h => 
                            h && h.toString().toLowerCase().includes(patron.toLowerCase())
                        );
                        if (indice >= 0) return indice;
                    }
                    return -1;
                };
                
                const colIndices = {
                    expediente: encontrarIndice(['expediente', 'numero', 'numexp', 'n√∫mero', 'id']),
                    fechaApertura: encontrarIndice(['fecha apertura', 'fecha_apertura', 'apertura']),
                    fechaReasignacion: encontrarIndice(['fecha reasignacion', 'fecha_reasignacion', 'reasignacion']),
                    responsable: encontrarIndice(['responsable', 'funcionario', 'auditor', 'encargado']),            
                };
                
                if (colIndices.responsable === -1 && headers.length > 0) {
                    colIndices.responsable = 0;
                }
                
                const result = [];
                
                for (let i = 1; i < lines.length; i++) {
                    try {
                        const values = parseCSVLine(lines[i]);
                        if (values.length === 0) continue;
                        
                        const numeroExpediente = colIndices.expediente >= 0 ? String(values[colIndices.expediente] || '').trim() : '';
                        const fechaApertura = colIndices.fechaApertura >= 0 ? String(values[colIndices.fechaApertura] || '').trim() : '';
                        const fechaReasignacion = colIndices.fechaReasignacion >= 0 ? String(values[colIndices.fechaReasignacion] || '').trim() : '';
                        const responsable = colIndices.responsable >= 0 ? String(values[colIndices.responsable] || '').trim() : '';                
                        
                        if (numeroExpediente || responsable) {
                            const semaforo = calcularSemaforizacion(fechaApertura, fechaReasignacion);
                            const descripcion = generarDescripcion(semaforo);
                            
                            result.push({
                                id: result.length + 1,
                                nombre: numeroExpediente || `Expediente ${result.length + 1}`,
                                descripcion: descripcion,
                                estado: semaforo.estado,
                                tiempo: semaforo.tiempo,
                                responsable: responsable || 'No asignado',
                                fechaRevision: semaforo.fechaBase,
                                fechaApertura: fechaApertura,
                                fechaReasignacion: fechaReasignacion
                            });
                        }
                        
                    } catch (error) {
                        continue;
                    }
                }
                
                return result;
                
            } catch (error) {
                throw new Error('Error CSV: ' + error.message);
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            
            return result.map(field => {
                if (field.startsWith('"') && field.endsWith('"')) {
                    return field.substring(1, field.length - 1);
                }
                return field;
            });
        }

        function extraerUsuariosDeExpedientes(expedientesArray) {
            const usuariosUnicos = [];
            const usuariosMap = new Map();
        
            expedientesArray.forEach(exp => {
                if (exp.responsable && exp.responsable !== 'No asignado') {
                    if (!usuariosMap.has(exp.responsable)) {
                        const usuario = {
                            id: Date.now() + usuariosUnicos.length,
                            nombre: exp.responsable,
                            email: "",
                            activo: true,
                            origen: 'archivo'
                        };
                        usuariosMap.set(exp.responsable, usuario);
                        usuariosUnicos.push(usuario);
                    }
                }
            });
        
            return usuariosUnicos;
        }

        // ==============================================
        // GESTI√ìN DE USUARIOS
        // ==============================================
        function cargarListaUsuarios() {
            const userList = document.getElementById('userList');
            if (!userList) return;
            
            if (usuariosDisponibles.length === 0) {
                userList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p>No hay usuarios registrados.</p>
                        <p>Cargue un archivo de expedientes primero.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            usuariosDisponibles.forEach((usuario, index) => {
                const nombreLimpio = extraerNombreSinDocumento(usuario.nombre);
                const expedientesUsuario = expedientes.filter(e => 
                    extraerNombreSinDocumento(e.responsable) === nombreLimpio
                );
                const vencidos = expedientesUsuario.filter(e => e.estado === 'rojo').length;
                
                html += `
                    <div class="user-item">
                        <div class="user-info">
                            <input type="checkbox" id="user-checkbox-${usuario.id}" ${usuario.activo ? 'checked' : ''} 
                                   onchange="toggleUsuarioActivo(${usuario.id})">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%); 
                                       color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                                       font-weight: bold; font-size: 16px;">
                                ${nombreLimpio.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h4 style="margin: 0; font-size: 16px;">${nombreLimpio}</h4>
                                <p style="margin: 2px 0 0 0; font-size: 14px; color: #666;">${usuario.email || 'Sin correo'}</p>
                                <p style="margin: 2px 0 0 0; font-size: 12px; color: #888;">
                                    Expedientes: ${expedientesUsuario.length} 
                                    ${vencidos > 0 ? `‚Ä¢ üî¥ ${vencidos} vencidos` : ''}
                                </p>
                            </div>
                        </div>
                        <div class="user-actions">
                            <button class="btn-icon" onclick="editarUsuario(${usuario.id})" title="Editar">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn-icon" onclick="eliminarUsuario(${usuario.id})" title="Eliminar">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            });
            
            userList.innerHTML = html;
        }

        function toggleUsuarioActivo(id) {
            const usuario = usuariosDisponibles.find(u => u.id === id);
            if (usuario) {
                usuario.activo = !usuario.activo;
                guardarConfiguracion();
                mostrarNotificacion(`Usuario ${usuario.activo ? 'activado' : 'desactivado'}`, 'success');
            }
        }

        function agregarUsuario() {
            const nombre = prompt('Nombre del usuario:');
            if (!nombre) return;
            
            const email = prompt('Correo electr√≥nico:');
            
            const nuevoUsuario = {
                id: Date.now(),
                nombre: nombre,
                email: email || `${nombre.toLowerCase().replace(/\s+/g, '.')}@dif.gob.mx`,
                activo: true,
                origen: 'manual'
            };
            
            usuariosDisponibles.push(nuevoUsuario);
            
            cargarListaUsuarios();
            guardarConfiguracion();
            mostrarNotificacion('Usuario agregado', 'success');
        }

        function editarUsuario(id) {
            const usuario = usuariosDisponibles.find(u => u.id === id);
            if (!usuario) return;
            
            const nuevoNombre = prompt('Nuevo nombre:', usuario.nombre);
            if (!nuevoNombre) return;
            
            const nuevoEmail = prompt('Nuevo correo:', usuario.email || '');
            
            usuario.nombre = nuevoNombre;
            usuario.email = nuevoEmail;
            
            cargarListaUsuarios();
            guardarConfiguracion();
            mostrarNotificacion('Usuario actualizado', 'success');
        }

        function eliminarUsuario(id) {
            if (!confirm('¬øEliminar este usuario?')) return;
            
            usuariosDisponibles = usuariosDisponibles.filter(u => u.id !== id);
            
            cargarListaUsuarios();
            guardarConfiguracion();
            mostrarNotificacion('Usuario eliminado', 'success');
        }

        function eliminarTodosUsuarios() {
            if (!confirm('¬øEliminar TODOS los usuarios?')) return;
            
            usuariosDisponibles = [];
            
            cargarListaUsuarios();
            guardarConfiguracion();
            mostrarNotificacion('Todos los usuarios eliminados', 'success');
        }

        // ==============================================
        // FUNCIONES DE INTERFAZ
        // ==============================================
        function actualizarTabla() {
            const tbody = document.getElementById('table-body');
            if (!tbody) return;
            
            if (filteredExpedientes.length === 0) {
                mostrarPantallaBienvenida();
                return;
            }
            
            let html = '';
            filteredExpedientes.forEach((expediente) => {
                const estadoClass = `badge-${expediente.estado}`;
                const estadoIcon = expediente.estado === 'verde' ? '‚úÖ' : 
                                  expediente.estado === 'amarillo' ? '‚ö†Ô∏è' : 
                                  expediente.estado === 'naranja' ? 'üü†' : 'üî¥';
                
                html += `
                    <tr class="fade-in">
                        <td>
                            <strong style="font-size: 16px;">${expediente.nombre}</strong>
                        </td>
                        <td>
                            <div style="max-width: 400px;">
                                ${expediente.descripcion}
                                ${expediente.fechaApertura ? `<br><small style="color: #666;">Apertura: ${expediente.fechaApertura}</small>` : ''}
                                ${expediente.fechaReasignacion ? `<br><small style="color: #666;">Reasignaci√≥n: ${expediente.fechaReasignacion}</small>` : ''}
                            </div>
                        </td>
                        <td>
                            <span class="status-badge ${estadoClass}">
                                ${estadoIcon} ${expediente.estado.toUpperCase()}
                            </span>
                        </td>
                        <td><strong>${expediente.tiempo}</strong></td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%); 
                                          color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                                          font-weight: bold; font-size: 12px;">
                                    ${expediente.responsable.charAt(0).toUpperCase()}
                                </div>
                                ${expediente.responsable}
                            </div>
                        </td>
                        <td>${expediente.fechaRevision || 'No disponible'}</td>
                        <td>
                            <button class="btn-icon" onclick="verDetalleExpediente(${expediente.id})" title="Ver detalles">
                                üëÅÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function filtrarExpedientes() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            if (!searchTerm) {
                if (funcionarioActual && funcionarioActual !== 'Administrador') {
                    filteredExpedientes = expedientes.filter(exp => {
                        const nombreEnExpediente = extraerNombreSinDocumento(exp.responsable);
                        return nombreEnExpediente === funcionarioActual;
                    });
                } else {
                    filteredExpedientes = [...expedientes];
                }
            } else {
                filteredExpedientes = expedientes.filter(exp => 
                    exp.nombre.toLowerCase().includes(searchTerm) ||
                    exp.descripcion.toLowerCase().includes(searchTerm) ||
                    exp.responsable.toLowerCase().includes(searchTerm)
                );
            }
            
            actualizarTabla();
            actualizarEstadisticas();
        }

        function actualizarEstadisticas() {
            document.getElementById('total-count').textContent = filteredExpedientes.length;
            document.getElementById('verde-count').textContent = filteredExpedientes.filter(e => e.estado === 'verde').length;
            document.getElementById('amarillo-count').textContent = filteredExpedientes.filter(e => e.estado === 'amarillo').length;
            document.getElementById('rojo-count').textContent = filteredExpedientes.filter(e => e.estado === 'rojo').length;
            
            document.querySelectorAll('.verde').forEach(el => el.style.color = '#2E7D32');
            document.querySelectorAll('.amarillo').forEach(el => el.style.color = '#F57C00');
            document.querySelectorAll('.rojo').forEach(el => el.style.color = '#C62828');
        }

        function verDetalleExpediente(id) {
            const expediente = expedientes.find(e => e.id === id);
            if (!expediente) return;
            
            alert(`üìã DETALLE DEL EXPEDIENTE\n\n` +
                  `Expediente: ${expediente.nombre}\n` +
                  `Estado: ${expediente.estado.toUpperCase()}\n` +
                  `Tiempo: ${expediente.tiempo}\n` +
                  `Descripci√≥n: ${expediente.descripcion}\n` +
                  `Responsable: ${expediente.responsable}\n` +
                  `Fecha base: ${expediente.fechaRevision || 'No disponible'}\n` +
                  `Fecha apertura: ${expediente.fechaApertura || 'No disponible'}\n` +
                  `Fecha reasignaci√≥n: ${expediente.fechaReasignacion || 'No disponible'}`);
        }

        // ==============================================
        // GESTI√ìN DE FECHAS
        // ==============================================
        function actualizarDisplayFechaReferencia() {
            const fechaDisplay = document.getElementById('fechaReferenciaActual');
            if (fechaDisplay) {
                fechaDisplay.textContent = fechaReferencia.toISOString().split('T')[0];
            }
        }

        function cambiarFechaReferencia() {
            const nuevaFecha = prompt('Ingrese nueva fecha de referencia (YYYY-MM-DD):', 
                                      fechaReferencia.toISOString().split('T')[0]);
            
            if (!nuevaFecha) return;
            
            const fecha = new Date(nuevaFecha);
            if (isNaN(fecha.getTime())) {
                mostrarNotificacion('Fecha inv√°lida', 'error');
                return;
            }
            
            fechaReferencia = fecha;
            actualizarDisplayFechaReferencia();
            recalcularTodosExpedientes();
            mostrarNotificacion('Fecha actualizada', 'success');
        }

        function usarFechaActual() {
            fechaReferencia = new Date();
            actualizarDisplayFechaReferencia();
            recalcularTodosExpedientes();
            mostrarNotificacion('Usando fecha actual', 'success');
        }

        function recalcularTodosExpedientes() {
            expedientes.forEach(exp => {
                const semaforo = calcularSemaforizacion(exp.fechaApertura, exp.fechaReasignacion);
                exp.estado = semaforo.estado;
                exp.tiempo = semaforo.tiempo;
                exp.descripcion = generarDescripcion(semaforo);
                exp.mesesFaltantes = semaforo.mesesFaltantes;
                exp.mesesTranscurridos = semaforo.mesesTranscurridos;
            });
            
            filteredExpedientes = [...expedientes];
            actualizarTabla();
            actualizarEstadisticas();
            mostrarNotificacion('Expedientes recalculados', 'success');
        }

        // ==============================================
        // GUARDAR Y CARGAR CONFIGURACI√ìN
        // ==============================================
        function guardarConfiguracion() {
            const configuracion = {
                expedientes: expedientes,
                usuariosDisponibles: usuariosDisponibles,
                historialSubidas: historialSubidas,
                fechaReferencia: fechaReferencia.toISOString()
            };
            
            localStorage.setItem('dif_configuracion', JSON.stringify(configuracion));
            mostrarNotificacion('Configuraci√≥n guardada', 'success');
        }

        function cargarConfiguracionGuardada() {
            const configuracionGuardada = localStorage.getItem('dif_configuracion');
            
            if (configuracionGuardada) {
                try {
                    const config = JSON.parse(configuracionGuardada);
                    
                    expedientes = config.expedientes || [];
                    usuariosDisponibles = config.usuariosDisponibles || [];
                    historialSubidas = config.historialSubidas || [];
                    if (config.fechaReferencia) fechaReferencia = new Date(config.fechaReferencia);
                    
                    filteredExpedientes = [...expedientes];
                    
                } catch (error) {
                    console.log('Error cargando configuraci√≥n:', error);
                }
            }
        }

        function limpiarDatos() {
            if (confirm('¬øEliminar TODOS los datos del sistema?\n\nEsta acci√≥n no se puede deshacer.')) {
                expedientes = [];
                filteredExpedientes = [];
                usuariosDisponibles = [];
                historialSubidas = [];
                archivoCargado = null;
                funcionarioActual = null;
                
                localStorage.removeItem('dif_configuracion');
                localStorage.removeItem('dif_documento_usuario');
                
                mostrarPantallaBienvenida();
                actualizarEstadisticas();
                actualizarInfoBackup();
                actualizarEstadisticasNotificaciones();
                
                mostrarNotificacion('Todos los datos han sido eliminados', 'success');
                
                setTimeout(() => {
                    pedirDocumentoUsuario();
                }, 500);
            }
        }

        // ==============================================
        // EXPORTAR A EXCEL
        // ==============================================
        function exportarExcel() {
            if (expedientes.length === 0) {
                mostrarNotificacion('No hay datos para exportar', 'warning');
                return;
            }
            
            try {
                const ws = XLSX.utils.json_to_sheet(expedientes.map(exp => ({
                    'Expediente': exp.nombre,
                    'Descripci√≥n': exp.descripcion,
                    'Estado': exp.estado.toUpperCase(),
                    'Tiempo Restante': exp.tiempo,
                    'Responsable': exp.responsable,
                    'Fecha Base': exp.fechaRevision,
                    'Fecha Apertura': exp.fechaApertura,
                    'Fecha Reasignaci√≥n': exp.fechaReasignacion,
                    'Meses Faltantes': exp.mesesFaltantes?.toFixed(1) || 'N/A',
                    'Meses Transcurridos': exp.mesesTranscurridos?.toFixed(1) || 'N/A'
                })));
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Expedientes");
                
                const fecha = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `Expedientes_DIF_${fecha}.xlsx`);
                
                mostrarNotificacion('Archivo Excel generado', 'success');
                
            } catch (error) {
                mostrarNotificacion(`Error exportando: ${error.message}`, 'error');
            }
        }

        // ==============================================
        // NOTIFICACIONES
        // ==============================================
        function mostrarNotificacion(mensaje, tipo = 'info') {
            const notificacion = document.createElement('div');
            notificacion.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${tipo === 'success' ? '#d4edda' : 
                            tipo === 'warning' ? '#fff3cd' : 
                            tipo === 'error' ? '#f8d7da' : '#d1ecf1'};
                color: ${tipo === 'success' ? '#155724' : 
                        tipo === 'warning' ? '#856404' : 
                        tipo === 'error' ? '#721c24' : '#0c5460'};
                border: 1px solid ${tipo === 'success' ? '#c3e6cb' : 
                                  tipo === 'warning' ? '#ffeeba' : 
                                  tipo === 'error' ? '#f5c6cb' : '#bee5eb'};
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 9999;
                animation: fadeIn 0.3s, slideInRight 0.3s;
                max-width: 400px;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            
            const icono = tipo === 'success' ? '‚úÖ' : 
                         tipo === 'warning' ? '‚ö†Ô∏è' : 
                         tipo === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
            
            notificacion.innerHTML = `
                <span style="font-size: 20px;">${icono}</span>
                <span>${mensaje}</span>
            `;
            
            document.body.appendChild(notificacion);
            
            setTimeout(() => {
                notificacion.style.animation = 'fadeOut 0.3s';
                setTimeout(() => {
                    if (notificacion.parentNode) {
                        notificacion.parentNode.removeChild(notificacion);
                    }
                }, 300);
            }, 3000);
        }

        // ==============================================
        // INICIALIZAR ANIMACIONES
        // ==============================================
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
            
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                20%, 40%, 60%, 80% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(style);

    </script>
</body>
</html>
